<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI é¡Œåº«ç”ŸæˆåŠç®¡ç†å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
        }
        /* æ™®æ™®è—è¡“é¢¨æ ¼å…ƒä»¶ */
        .pop-card {
            background-color: white;
            border: 4px solid black;
            box-shadow: 8px 8px 0 0 #000;
            transition: all 0.2s ease-in-out;
        }
        .pop-button {
            border: 3px solid black;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            box-shadow: 4px 4px 0 0 #000;
        }
        .pop-button:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 0 #000;
        }
        .pop-button:active {
            transform: translate(4px, 4px);
            box-shadow: none;
        }
        .pop-input, .pop-textarea, .pop-select {
            border: 3px solid black;
            transition: all 0.2s ease-in-out;
        }
        .pop-input:focus, .pop-textarea:focus, .pop-select:focus {
            outline: none;
            box-shadow: 0 0 0 4px #facc15; /* yellow-400 */
        }
        .pop-tab {
            border: 3px solid black;
            border-bottom: none;
            margin-bottom: -3px;
            font-weight: 700;
        }
        .pop-tab.active {
            background-color: #fef08a; /* yellow-200 */
        }
        .pop-tab-content {
            border: 3px solid black;
        }
        /* é»ç‹€èƒŒæ™¯ */
        .dots-bg {
            background-image: radial-gradient(circle, #000 1px, transparent 1px);
            background-size: 15px 15px;
        }
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 50;
        }
        /* è¼‰å…¥å‹•ç•« */
        .loader {
            width: 50px;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 8px solid #0000;
            border-right-color: #f87171; /* red-400 */
            position: relative;
            animation: l24 1s infinite linear;
        }
        .loader:before,
        .loader:after {
            content: "";
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: inherit;
            animation: inherit;
            animation-duration: 2s;
        }
        .loader:after {
            animation-duration: 4s;
        }
        @keyframes l24 {
            100% {transform: rotate(1turn)}
        }
    </style>
</head>
<body class="bg-yellow-300">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl relative">
        <!-- Settings Button -->
        <div class="absolute top-4 right-4 z-10">
            <button id="settings-btn" class="pop-button bg-white p-3 rounded-full text-2xl" title="è¨­å®š">âš™ï¸</button>
        </div>

        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-12">
            <div class="relative inline-block">
                <h1 class="text-5xl md:text-7xl font-black text-black inline-block p-4 bg-red-500 border-4 border-black" style="transform: rotate(-2deg);">
                    AI é¡Œåº«ç”ŸæˆåŠç®¡ç†å·¥å…·
                </h1>
                <span class="absolute -top-2 -right-4 text-sm font-bold text-gray-600 bg-yellow-300 border-2 border-black px-2 py-1 rounded transform rotate-12" style="box-shadow: 2px 2px 0 0 #000;">
                    API from å¥•éˆè€å¸«
                </span>
            </div>
            <p class="text-xl font-bold mt-4 text-black">POP ART EDITION!</p>
        </header>

        <main class="max-w-6xl mx-auto">
            <!-- é ‚éƒ¨æ“ä½œæŒ‰éˆ•å€ -->
            <div class="flex justify-center gap-4 mb-8">
                <button id="open-material-modal" class="pop-button bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-bold flex items-center gap-2">
                    ğŸ“š æ–°å¢æ•™æ
                </button>
                <button id="open-batch-add-modal" class="pop-button bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-bold flex items-center gap-2">
                    âœï¸ æ‰¹æ¬¡æ–°å¢
                </button>
                <button id="open-data-modal" class="pop-button bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg text-lg font-bold flex items-center gap-2">
                    ğŸ’¾ è³‡æ–™ç®¡ç†
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- å·¦å´ï¼šæˆ‘çš„é¡Œåº« -->
                <section id="bank-section">
                    <div class="pop-card p-6">
                        <h2 class="text-3xl font-black mb-4 flex items-center">
                            <span class="text-white bg-green-500 rounded-full w-10 h-10 flex items-center justify-center text-xl mr-3 border-2 border-black">ğŸ“š</span>
                            æˆ‘çš„é¡Œåº«
                        </h2>
                        <div id="bank-list">
                            <!-- é¡Œåº«åˆ—è¡¨å°‡å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
                        </div>
                    </div>
                </section>

                <!-- å³å´ï¼šå‡ºé¡Œèˆ‡åŒ¯å‡º -->
            <section id="output-section">
                 <div class="pop-card p-6 dots-bg">
                    <h2 class="text-3xl font-black mb-4 flex items-center">
                        <span class="text-white bg-red-500 rounded-full w-10 h-10 flex items-center justify-center text-xl mr-3 border-2 border-black">ğŸ¯</span>
                        ç”Ÿæˆç·´ç¿’èˆ‡åŒ¯å‡º
                    </h2>
                    <div id="quiz-generator">
                         <div class="bg-white/80 backdrop-blur-sm p-4 border-2 border-dashed border-black rounded-lg">
                            <p class="font-bold text-lg mb-2">è«‹å…ˆå¾å·¦å´é¸æ“‡è¦ä½¿ç”¨çš„é¡Œåº«ã€‚</p>
                            <div class="mb-4">
                                <p class="font-bold">ç”Ÿæˆæ¨¡å¼ï¼š</p>
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    <button id="generate-quiz-btn-auto" class="w-full pop-button bg-blue-400 hover:bg-blue-500 text-white py-2 text-lg rounded-lg" disabled>è‡ªå‹•ç”Ÿæˆ</button>
                                    <button id="generate-quiz-btn-manual" class="w-full pop-button bg-teal-400 hover:bg-teal-500 text-white py-2 text-lg rounded-lg" disabled>æ‰‹å‹•é¸é¡Œ</button>
                                </div>
                            </div>
                            <div id="auto-generate-options">
                                <div class="mb-4">
                                    <label for="num-questions" class="font-bold">ç¸½é¡Œæ•¸ï¼š</label>
                                    <input type="number" id="num-questions" value="10" min="1" class="pop-input w-24 p-1 text-center">
                                </div>
                                <div class="mb-4" id="difficulty-selection-container">
                                    <p class="font-bold" id="difficulty-title">é›£åº¦åå¥½ï¼š</p>
                                    <div class="flex space-x-4" id="difficulty-options">
                                        <label><input type="checkbox" class="difficulty-pref" value="Easy" checked> ç°¡å–®</label>
                                        <label><input type="checkbox" class="difficulty-pref" value="Medium" checked> ä¸­ç­‰</label>
                                        <label><input type="checkbox" class="difficulty-pref" value="Hard" checked> å›°é›£</label>
                                    </div>
                                </div>
                            </div>
                         </div>
                    </div>
                    
                    <div id="quiz-preview" class="mt-6 hidden">
                         <h3 class="text-2xl font-black mb-2">ç·´ç¿’é¡Œé è¦½</h3>
                         <div id="quiz-preview-list" class="bg-white/80 backdrop-blur-sm p-4 border-2 border-dashed border-black rounded-lg max-h-96 overflow-y-auto">
                            <!-- é è¦½é¡Œç›®å°‡é¡¯ç¤ºæ–¼æ­¤ -->
                         </div>
                         <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                            <button id="export-wordwall-btn" class="w-full pop-button bg-purple-400 hover:bg-purple-500 text-white py-2 rounded-lg">åŒ¯å‡º Wordwall</button>
                            <button id="export-kahoot-btn" class="w-full pop-button bg-indigo-400 hover:bg-indigo-500 text-white py-2 rounded-lg">åŒ¯å‡º Kahoot!</button>
                            <button id="export-publisher-btn" class="w-full pop-button bg-orange-400 hover:bg-orange-500 text-white py-2 rounded-lg">åŒ¯å‡ºæ›¸å•†æ ¼å¼</button>
                            <button id="export-wayground-btn" class="w-full pop-button bg-teal-400 hover:bg-teal-500 text-white py-2 rounded-lg">åŒ¯å‡º Wayground</button>
                            <button id="export-google-forms-btn" class="w-full pop-button bg-green-400 hover:bg-green-500 text-white py-2 rounded-lg">åŒ¯å‡º Google è¡¨å–®</button>
                            <button id="export-game-btn" class="w-full pop-button bg-pink-400 hover:bg-pink-500 text-white py-2 rounded-lg">ä¸‹è¼‰éŠæˆ² HTML</button>
                         </div>
                         <div class="mt-4 p-4 bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg">
                            <p class="text-sm font-bold text-blue-700 mb-2">ğŸ’¡ æ›¸å•†æ ¼å¼åŒ¯å‡ºæç¤ºï¼š</p>
                            <p class="text-sm text-gray-700 mb-2">åŒ¯å‡ºæ›¸å•†æ ¼å¼å¾Œï¼Œå¯ç›´æ¥åˆ°
                                <a href="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/html%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7%E9%9B%86%E5%90%88/html_textarea_chang.html"
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   class="text-blue-600 font-bold underline hover:text-blue-800">
                                   é˜¿å‰›è€å¸«çš„HTMLéŠæˆ²è‡ªè¨‚å…§å®¹å·¥å…·
                                </a>
                                é¸æ“‡ã€Œé¸æ“‡é¡Œå‹çš„éŠæˆ²ã€ç›´æ¥è²¼ä¸Šç”ŸæˆéŠæˆ²HTMLã€‚
                            </p>
                         </div>
                         <div class="mt-4 p-4 bg-green-50 border-2 border-dashed border-green-300 rounded-lg">
                            <p class="text-sm font-bold text-green-700 mb-2">ğŸ“ Google è¡¨å–®åŒ¯å‡ºæç¤ºï¼š</p>
                            <p class="text-sm text-gray-700">åŒ¯å‡º Google è¡¨å–®æœƒç”¢ç”Ÿ GAS ç¨‹å¼ç¢¼ï¼Œè«‹å»ºç«‹ä¸€å€‹æ–°çš„ Google è¡¨å–®ï¼Œé€²å…¥æŒ‡ä»¤ç¢¼ç·¨è¼¯å™¨è²¼ä¸Šç¨‹å¼ç¢¼ä¸¦åŸ·è¡Œï¼Œå³å¯è‡ªå‹•å»ºç«‹æ¸¬é©—è¡¨å–®ã€‚</p>
                         </div>
                    </div>
                 </div>

            </section>
        </main>
    </div>

    <!-- è¼‰å…¥ä¸­ Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center hidden z-100">
        <div class="loader"></div>
        <p id="loading-text" class="text-white text-2xl font-bold mt-6">AI æ­£åœ¨åŠªåŠ›ç‚ºæ‚¨ç”Ÿæˆé¡Œç›®...</p>
    </div>

    <!-- ç·¨è¼¯é¡Œåº« Modal -->
    <div id="edit-bank-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-4xl h-5/6 flex flex-col">
            <h2 id="edit-modal-title" class="text-2xl font-black p-4 border-b-4 border-black">ç·¨è¼¯é¡Œåº«</h2>
            <div id="edit-modal-content" class="p-6 overflow-y-auto flex-grow">
                <!-- ç·¨è¼¯å…§å®¹å°‡å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="edit-modal-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">å–æ¶ˆ</button>
                <button id="edit-modal-save" class="pop-button bg-green-400 hover:bg-green-500 px-6 py-2 rounded-lg">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹æ¬¡æ–°å¢é¡Œåº« Modal -->
    <div id="add-questions-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-3xl flex flex-col max-h-[90vh]">
            <h2 class="text-2xl font-black p-4 border-b-4 border-black">æ‰¹æ¬¡å»ºç«‹æ–°é¡Œåº«</h2>
            <div class="p-6 overflow-y-auto flex-grow space-y-4">
                <div>
                    <label for="new-bank-name" class="font-bold">æ–°é¡Œåº«åç¨±:</label>
                    <input type="text" id="new-bank-name" class="w-full pop-input p-2 mt-1" placeholder="ä¾‹å¦‚ï¼šåœ‹æ–‡ç¬¬ä¸‰èª²ç·´ç¿’">
                </div>
                <div>
                    <label for="new-question-category" class="font-bold">é¡Œç›®åˆ†é¡åç¨±:</label>
                    <input type="text" id="new-question-category" class="w-full pop-input p-2 mt-1" placeholder="ä¾‹å¦‚ï¼šå½¢è¿‘å­—ç·´ç¿’">
                </div>
                <div>
                     <label for="new-question-type" class="font-bold">é¡Œç›®é¡å‹:</label>
                     <select id="new-question-type" class="w-full pop-select p-2 mt-1">
                        <option value="knowledge" selected>çŸ¥è­˜é» (ç°¡å–®/ä¸­ç­‰/å›°é›£)</option>
                        <option value="comprehension">é–±è®€ç†è§£ (PISA å››å±¤æ¬¡)</option>
                     </select>
                </div>
                <div>
                     <label for="new-question-difficulty" class="font-bold">è¨­å®šé›£åº¦/å±¤æ¬¡:</label>
                     <select id="new-question-difficulty" class="w-full pop-select p-2 mt-1">
                        <!-- Options will be populated by JS -->
                     </select>
                </div>
                <div>
                    <label for="batch-input-text" class="font-bold">è²¼ä¸Šé¡Œç›® (æ›¸å•†æ ¼å¼):</label>
                    <textarea id="batch-input-text" class="w-full h-48 pop-textarea p-2 mt-1" placeholder="æ ¼å¼ï¼šé¡Œç›®(Tab)æ­£ç¢ºç­”æ¡ˆé¸é …æ•¸å­—(Tab)é¸é …A(Tab)é¸é …B(Tab)é¸é …C(Tab)é¸é …D(Enter)"></textarea>
                    <p class="text-sm text-gray-600 mt-1">æ¯ä¸€è¡Œä»£è¡¨ä¸€é¡Œã€‚è«‹ä½¿ç”¨ Tab éµåˆ†éš”æ¯å€‹æ¬„ä½ã€‚</p>
                </div>
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="add-questions-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">å–æ¶ˆ</button>
                <button id="add-questions-save" class="pop-button bg-green-400 hover:bg-green-500 px-6 py-2 rounded-lg">å»ºç«‹é¡Œåº«</button>
            </div>
        </div>
    </div>

    <!-- æ‰‹å‹•é¸é¡Œ Modal -->
    <div id="manual-select-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-4xl h-5/6 flex flex-col">
            <h2 class="text-2xl font-black p-4 border-b-4 border-black">æ‰‹å‹•é¸æ“‡é¡Œç›®</h2>
            <div id="manual-select-content" class="p-6 overflow-y-auto flex-grow">
                <!-- é¡Œç›®åˆ—è¡¨å°‡å‹•æ…‹ç”Ÿæˆæ–¼æ­¤ -->
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="manual-select-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">å–æ¶ˆ</button>
                <button id="manual-select-done" class="pop-button bg-blue-400 hover:bg-blue-500 px-6 py-2 rounded-lg">å®Œæˆé¸é¡Œ</button>
            </div>
        </div>
    </div>

    <!-- è¨­å®š Modal -->
    <div id="settings-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-2xl flex flex-col">
            <h2 class="text-2xl font-black p-4 border-b-4 border-black">AI ä¾†æºè¨­å®š</h2>
            <div class="p-6 overflow-y-auto flex-grow space-y-6">
                <!-- AI Source Selection -->
                <div>
                    <label class="font-bold text-lg">é¸æ“‡ AI ä¾†æº:</label>
                    <div class="mt-2 space-y-2">
                        <label class="flex items-center p-3 border-2 border-black rounded-lg has-[:checked]:bg-yellow-200 cursor-pointer">
                            <input type="radio" name="ai-source" value="default" class="h-5 w-5 mr-3">
                            <div>
                                <p class="font-bold">é è¨­ Gemini</p>
                                <p class="text-sm text-gray-600">ä½¿ç”¨å…§å»ºçš„ Gemini æ¨¡å‹ï¼Œç„¡éœ€è¨­å®šã€‚</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 border-black rounded-lg has-[:checked]:bg-yellow-200 cursor-pointer">
                            <input type="radio" name="ai-source" value="gemini_api" class="h-5 w-5 mr-3">
                            <div>
                                <p class="font-bold">Gemini API Key</p>
                                <p class="text-sm text-gray-600">ä½¿ç”¨æ‚¨è‡ªå·±çš„ Google AI Gemini API é‡‘é‘°ã€‚</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border-2 border-black rounded-lg has-[:checked]:bg-yellow-200 cursor-pointer">
                            <input type="radio" name="ai-source" value="ollama" class="h-5 w-5 mr-3">
                            <div>
                                <p class="font-bold">æœ¬åœ° Ollama</p>
                                <p class="text-sm text-gray-600">é€£æ¥åˆ°æ‚¨åœ¨æœ¬åœ°é‹è¡Œçš„ Ollama æœå‹™ã€‚</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Gemini API Key Section -->
                <div id="gemini-api-settings" class="hidden pl-8">
                    <label for="gemini-api-key" class="font-bold">æ‚¨çš„ Gemini API Key:</label>
                    <input type="password" id="gemini-api-key" class="w-full pop-input p-2 mt-1" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key">
                </div>

                <!-- Ollama Section -->
                <div id="ollama-settings" class="hidden pl-8 space-y-4">
                    <div>
                        <label for="ollama-url" class="font-bold">Ollama URL:</label>
                        <input type="text" id="ollama-url" class="w-full pop-input p-2 mt-1" placeholder="ä¾‹å¦‚: http://localhost:11434">
                    </div>
                    <div>
                        <label for="ollama-model" class="font-bold">é¸æ“‡æ¨¡å‹:</label>
                        <div class="flex items-center gap-2 mt-1">
                            <select id="ollama-model" class="pop-select p-2 w-full">
                                <option value="">è«‹å…ˆç²å–æ¨¡å‹åˆ—è¡¨</option>
                            </select>
                            <button id="fetch-ollama-models-btn" class="pop-button bg-blue-400 text-white px-4 py-2 rounded-lg flex-shrink-0">ç²å–</button>
                        </div>
                         <p id="ollama-status" class="text-sm text-gray-500 mt-1 h-4"></p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="settings-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">å–æ¶ˆ</button>
                <button id="settings-save" class="pop-button bg-green-400 hover:bg-green-500 px-6 py-2 rounded-lg">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢æ•™æ Modal -->
    <div id="material-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-4xl h-5/6 flex flex-col">
            <h2 class="text-2xl font-black p-4 border-b-4 border-black">æ–°å¢æ•™æ</h2>
            <div class="p-6 overflow-y-auto flex-grow">
                <!-- é ç±¤ -->
                <div class="flex mb-0">
                    <button id="tab-upload" class="pop-tab active px-4 py-2 rounded-t-lg">ä¸Šå‚³æª”æ¡ˆ</button>
                    <button id="tab-paste" class="pop-tab px-4 py-2 rounded-t-lg">è²¼ä¸Šæ–‡å­—</button>
                    <button id="tab-library" class="pop-tab px-4 py-2 rounded-t-lg">æ•™æåº«</button>
                </div>

                <!-- å…§å®¹é¢æ¿ -->
                <div class="pop-tab-content p-4 bg-white rounded-b-lg rounded-r-lg">
                    <!-- ä¸Šå‚³é¢æ¿ -->
                    <div id="content-upload">
                        <p class="mb-4 text-gray-600">æ”¯æ´ PDF æˆ– .txt ç´”æ–‡å­—æª”ã€‚</p>
                        <input type="file" id="file-input" class="w-full pop-input p-2" accept=".pdf,.txt">
                    </div>
                    <!-- è²¼ä¸Šæ–‡å­—é¢æ¿ -->
                    <div id="content-paste" class="hidden">
                         <p class="mb-2 text-gray-600">å°‡æ‚¨çš„æ•™ææ–‡å­—è²¼åœ¨ä¸‹æ–¹ã€‚</p>
                        <textarea id="text-input" class="w-full h-48 pop-textarea p-2" placeholder="åœ¨æ­¤è²¼ä¸Šæ–‡å­—..."></textarea>
                    </div>
                    <!-- æ•™æåº«é¢æ¿ -->
                    <div id="content-library" class="hidden">
                        <p class="mb-4 text-gray-600">é¸æ“‡ä¹‹å‰ä¸Šå‚³éçš„æ•™æï¼Œé‡æ–°ç”Ÿæˆæ–°çš„é¡Œåº«ã€‚</p>
                        <div id="material-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- æ•™æåˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        <p id="no-materials" class="text-gray-500 text-center py-8 hidden">ç›®å‰æ²’æœ‰å¯ç”¨çš„æ•™æã€‚</p>
                    </div>
                </div>

                <div class="mt-6">
                    <label for="bank-name" class="font-bold text-lg">ç‚ºé€™å€‹æ•™æå‘½åï¼š</label>
                    <input type="text" id="bank-name" class="w-full pop-input p-2 mt-1" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç« é‡é»æ•´ç†">
                </div>

                <div class="mt-6 border-t-2 border-dashed border-gray-300 pt-4">
                    <h3 class="font-bold text-lg mb-2">AI ç”Ÿæˆè¨­å®š</h3>
                    <!-- AI Gen Tabs -->
                    <div class="flex mb-0">
                        <button id="tab-gen-knowledge" class="pop-tab active px-4 py-2 rounded-t-lg text-sm">çŸ¥è­˜é»ç”Ÿæˆ</button>
                        <button id="tab-gen-comprehension" class="pop-tab px-4 py-2 rounded-t-lg text-sm">é–±è®€ç†è§£ç”Ÿæˆ</button>
                    </div>
                    <!-- AI Gen Content -->
                    <div class="pop-tab-content p-4 bg-white rounded-b-lg rounded-r-lg">
                        <!-- çŸ¥è­˜é»ç”Ÿæˆ -->
                        <div id="content-gen-knowledge">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center">
                                    <label for="num-easy" class="font-bold text-green-600">ç°¡å–®</label>
                                    <input type="number" id="num-easy" value="5" min="0" class="pop-input w-full p-2 text-center mt-1">
                                </div>
                                <div class="text-center">
                                    <label for="num-medium" class="font-bold text-yellow-600">ä¸­ç­‰</label>
                                    <input type="number" id="num-medium" value="5" min="0" class="pop-input w-full p-2 text-center mt-1">
                                </div>
                                <div class="text-center">
                                    <label for="num-hard" class="font-bold text-red-600">å›°é›£</label>
                                    <input type="number" id="num-hard" value="5" min="0" class="pop-input w-full p-2 text-center mt-1">
                                </div>
                            </div>
                        </div>
                        <!-- é–±è®€ç†è§£ç”Ÿæˆ -->
                        <div id="content-gen-comprehension" class="hidden">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center">
                                    <label for="num-comp-1" class="font-bold text-blue-600">æå–è¨Šæ¯</label>
                                    <input type="number" id="num-comp-1" value="5" min="0" class="pop-input w-full p-2 text-center mt-1">
                                </div>
                                <div class="text-center">
                                    <label for="num-comp-2" class="font-bold text-green-600">æ–‡æ„æ¨è«–</label>
                                    <input type="number" id="num-comp-2" value="5" min="0" class="pop-input w-full p-2 text-center mt-1">
                                </div>
                                <div class="text-center">
                                    <label for="num-comp-3" class="font-bold text-yellow-600">è©®é‡‹æ•´åˆ</label>
                                    <input type="number" id="num-comp-3" value="5" min="0" class="pop-input w-full p-2 text-center mt-1">
                                </div>
                                <div class="text-center">
                                    <label for="num-comp-4" class="font-bold text-red-600">åæ€è©•åƒ¹</label>
                                    <input type="number" id="num-comp-4" value="5" min="0" class="pop-input w-full p-2 text-center mt-1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="material-modal-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">å–æ¶ˆ</button>
                <button id="generate-btn" class="pop-button bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">ç”Ÿæˆé¡Œåº«</button>
            </div>
        </div>
    </div>

    <!-- è³‡æ–™ç®¡ç† Modal -->
    <div id="data-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-2xl flex flex-col">
            <h2 class="text-2xl font-black p-4 border-b-4 border-black">è³‡æ–™ç®¡ç†</h2>
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="import-data-btn" class="w-full pop-button bg-gray-200 hover:bg-gray-300 text-black py-3 rounded-lg text-lg">ğŸ“¥ æ–°å¢é¡Œåº«</button>
                    <button id="export-data-btn" class="w-full pop-button bg-gray-700 hover:bg-gray-800 text-white py-3 rounded-lg text-lg">ğŸ“¤ åŒ¯å‡ºå…¨éƒ¨è³‡æ–™</button>
                    <input type="file" id="import-file-input" class="hidden" accept=".json">
                </div>
                <div class="mt-4 p-3 bg-yellow-50 border-2 border-dashed border-yellow-300 rounded-lg">
                    <p class="text-sm font-bold text-yellow-700 mb-1">ğŸ’¡ æ–°å¢é¡Œåº«èªªæ˜ï¼š</p>
                    <p class="text-sm text-gray-700">å¾JSONæª”æ¡ˆåŒ¯å…¥é¡Œåº«ï¼Œæœƒè‡ªå‹•èˆ‡ç¾æœ‰é¡Œåº«æ¯”å°å…§å®¹ï¼Œç›¸åŒå…§å®¹çš„é¡Œåº«åªæœƒä¿ç•™ä¸€å€‹ï¼Œé¿å…é‡è¤‡ã€‚</p>
                </div>
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="data-modal-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²é¸æ“‡ Modal -->
    <div id="game-select-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-3xl flex flex-col max-h-[90vh]">
            <h2 class="text-2xl font-black p-4 border-b-4 border-black">é¸æ“‡éŠæˆ²é¡å‹</h2>
            <div class="p-6 overflow-y-auto flex-grow">
                <p class="text-gray-600 mb-4">è«‹é¸æ“‡è¦ä¸‹è¼‰çš„éŠæˆ²é¡å‹ï¼Œç³»çµ±æœƒè‡ªå‹•å°‡ç•¶å‰é¡Œåº«å¡«å…¥éŠæˆ²ä¸­ï¼š</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="game-options">
                    <button class="game-option-btn pop-button bg-red-400 hover:bg-red-500 text-white p-4 rounded-lg text-left" data-game="car-game" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/car-game.html">
                        <h3 class="font-bold text-lg">ğŸï¸ è³½è»ŠéŠæˆ²</h3>
                        <p class="text-sm opacity-90">åœ¨è³½è»Šçš„åŒæ™‚ç­”é¡Œ</p>
                    </button>
                    <button class="game-option-btn pop-button bg-blue-400 hover:bg-blue-500 text-white p-4 rounded-lg text-left" data-game="self-study" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/%E8%87%AA%E5%AD%B8%E8%A4%87%E7%BF%92%E6%B8%AC%E9%A9%97%E5%B7%A5%E5%85%B72.html">
                        <h3 class="font-bold text-lg">ğŸ“– è‡ªå­¸è¤‡ç¿’æ¸¬é©—</h3>
                        <p class="text-sm opacity-90">åŸºæœ¬çš„é¸æ“‡é¡Œæ¸¬é©—</p>
                    </button>
                    <button class="game-option-btn pop-button bg-green-400 hover:bg-green-500 text-white p-4 rounded-lg text-left" data-game="quiz-online" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/%E9%81%B8%E6%93%87%E9%A1%8C%E9%81%8A%E6%88%B2-%E6%89%93%E6%80%AA%E5%8D%87%E7%B4%9A/%E6%89%93%E6%80%AA%E5%8D%87%E7%B4%9A%E9%81%8A%E6%88%B2-%E9%81%B8%E6%93%87%E9%A1%8C.html">
                        <h3 class="font-bold text-lg">ğŸ“ æ‰“æ€ªå‡ç´šé¸æ“‡é¡Œæ¸¬é©—</h3>
                        <p class="text-sm opacity-90">ç­”é¡Œæ‰“æ€ªå‡ç´šçš„éŠæˆ²</p>
                    </button>
                    <button class="game-option-btn pop-button bg-purple-400 hover:bg-purple-500 text-white p-4 rounded-lg text-left" data-game="cat-dog-war" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/%E9%9B%99%E4%BA%BA%E5%B0%8D%E6%88%B0-%E8%B2%93%E7%8B%97%E5%A4%A7%E6%88%B0-%E8%87%AA%E8%A3%BD%E9%A1%8C%E5%BA%AB.html">
                        <h3 class="font-bold text-lg">ğŸ±ğŸ¶ è²“ç‹—å¤§æˆ°</h3>
                        <p class="text-sm opacity-90">é›™äººå°æˆ°ç­”é¡ŒéŠæˆ²</p>
                    </button>
                    <button class="game-option-btn pop-button bg-yellow-400 hover:bg-yellow-500 text-white p-4 rounded-lg text-left" data-game="brick-breaker" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/%E7%AD%94%E9%A1%8C%E6%89%93%E7%A3%9A%E5%A1%8AFinal.html">
                        <h3 class="font-bold text-lg">ğŸ§± ç­”é¡Œæ‰“ç£šå¡Š</h3>
                        <p class="text-sm opacity-90">æ‰“ç£šå¡ŠåŒæ™‚ç­”é¡Œ</p>
                    </button>
                    <button class="game-option-btn pop-button bg-orange-400 hover:bg-orange-500 text-white p-4 rounded-lg text-left" data-game="big-screen" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/others/%E5%A4%A7%E5%B1%8F%E9%81%B8%E6%93%87%E9%A1%8C%E6%90%B6%E7%AD%94%E9%81%8A%E6%88%B2.html">
                        <h3 class="font-bold text-lg">ğŸ“º å¤§å±é¸æ“‡é¡Œæ¶ç­”</h3>
                        <p class="text-sm opacity-90">é©åˆèª²å ‚æ¶ç­”</p>
                    </button>
                    <button class="game-option-btn pop-button bg-pink-400 hover:bg-pink-500 text-white p-4 rounded-lg text-left" data-game="fruit-ninja" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/ç´«è¶å¤§å±æ¸¬é©—/index.html">
                        <h3 class="font-bold text-lg">ğŸ¥· æ°´æœå¿è€…æ¶ç­”</h3>
                        <p class="text-sm opacity-90">å¤§å±äºŒäººæ¶ç­”éŠæˆ²</p>
                    </button>
                    <button class="game-option-btn pop-button bg-indigo-400 hover:bg-indigo-500 text-white p-4 rounded-lg text-left" data-game="butterfly" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/è´è¶é£›éŠæˆ²/flappybutterfly.html">
                        <h3 class="font-bold text-lg">ğŸ¦‹ ç´«è¶é£›éŠæˆ²</h3>
                        <p class="text-sm opacity-90">é¡ä¼¼Flappy Birdçš„ç­”é¡ŒéŠæˆ²</p>
                    </button>
					<button class="game-option-btn pop-button bg-indigo-400 hover:bg-indigo-500 text-white p-4 rounded-lg text-left" data-game="butterfly" data-url="https://filedn.com/laMtL9jmKf7JrDEQG0A6OPy/html/é¸æ“‡é¡ŒéŠæˆ²-å¤ªç©ºæ¢éšª/å¤ªç©ºæ¢éšª.html">
                        <h3 class="font-bold text-lg">å¤ªç©ºæ¢éšªéŠæˆ²</h3>
                        <p class="text-sm opacity-90">å¤ªç©ºæ¢éšªçš„ç­”é¡ŒéŠæˆ²</p>
                    </button>
                </div>
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="game-select-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Google Forms ç”Ÿæˆç¨‹å¼ç¢¼ Modal -->
    <div id="google-forms-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-4xl flex flex-col max-h-screen">
            <h2 class="text-2xl font-black p-4 border-b-4 border-black">Google è¡¨å–® GAS ç¨‹å¼ç¢¼</h2>
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="bg-gray-100 p-4 border-2 border-dashed border-gray-300 rounded-lg font-mono text-sm text-gray-800 min-h-[300px] max-h-[400px] overflow-y-auto">
                    <pre id="gas-code-content" class="whitespace-pre-wrap break-words"></pre>
                </div>
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="copy-gas-code-btn" class="pop-button bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">è¤‡è£½ç¨‹å¼ç¢¼</button>
                <button id="gas-instructions-btn" class="pop-button bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg">ä½¿ç”¨èªªæ˜</button>
                <button id="google-forms-modal-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- GAS ç¨‹å¼ç¢¼ä½¿ç”¨èªªæ˜ Modal -->
    <div id="gas-instructions-modal" class="modal-backdrop hidden items-center justify-center">
        <div class="pop-card w-11/12 max-w-3xl flex flex-col max-h-screen">
            <h2 class="text-2xl font-black p-4 border-b-4 border-black">GAS ç¨‹å¼ç¢¼ä½¿ç”¨èªªæ˜</h2>
            <div class="p-6 overflow-y-auto flex-grow">
                <div class="bg-blue-50 p-4 border-2 border-dashed border-blue-300 rounded-lg">
                    <p class="font-bold text-blue-700 mb-4">è¤‡è£½ä¸Šè¿°ç¨‹å¼ç¢¼å¾Œï¼Œè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š</p>
                    <ol class="list-decimal list-inside space-y-2 text-gray-700">
                        <li><strong>é–‹å•Ÿæ‚¨çš„ Google è¡¨å–®</strong>ï¼ˆæ‚¨å¯ä»¥å…ˆå»ºç«‹ä¸€å€‹ç©ºçš„è¡¨å–®ï¼‰ã€‚</li>
                        <li>é»æ“Šè¡¨å–®å³ä¸Šè§’çš„ã€Œæ›´å¤šã€åœ–ç¤ºï¼ˆä¸‰å€‹é»ï¼‰ï¼Œç„¶å¾Œé¸æ“‡ã€Œ<strong>æŒ‡ä»¤ç¢¼ç·¨è¼¯å™¨</strong>ã€ã€‚</li>
                        <li>åˆªé™¤ç·¨è¼¯å™¨ä¸­æ‰€æœ‰é è¨­çš„ç¨‹å¼ç¢¼ã€‚</li>
                        <li>å°‡æ‚¨è¤‡è£½çš„ç¨‹å¼ç¢¼è²¼åˆ°æŒ‡ä»¤ç¢¼ç·¨è¼¯å™¨ä¸­ã€‚</li>
                        <li>é»æ“Š<strong>å„²å­˜</strong>åœ–ç¤ºï¼ˆç£ç¢Ÿç‰‡å½¢ç‹€ï¼‰ã€‚</li>
                        <li>é»æ“Š<strong>åŸ·è¡Œ</strong>åœ–ç¤ºï¼ˆæ’­æ”¾ä¸‰è§’å½¢ï¼‰ã€‚</li>
                        <li>ç¬¬ä¸€æ¬¡åŸ·è¡Œæ™‚ï¼ŒGoogle æœƒè¦æ±‚æ‚¨æˆæ¬Šã€‚è«‹æŒ‰ç…§æŒ‡ç¤ºå®Œæˆæˆæ¬Šæµç¨‹ã€‚</li>
                        <li>ç¨‹å¼åŸ·è¡Œå®Œç•¢å¾Œï¼Œæ‚¨çš„ Google è¡¨å–®å°‡è‡ªå‹•æ–°å¢ç”Ÿæˆçš„é¸æ“‡é¡Œï¼Œä¸¦è¨­å®šå¥½ç­”æ¡ˆèˆ‡åˆ†æ•¸ã€‚</li>
                        <li><strong>é‡è¦æç¤ºï¼š</strong>è«‹ç¢ºä¿æ‚¨åŸ·è¡Œçš„æ˜¯æ–°ç”Ÿæˆçš„å‡½å¼åç¨± <code>createQuizForm</code>ã€‚</li>
                    </ol>
                    <div class="mt-4 p-3 bg-yellow-50 border-2 border-dashed border-yellow-300 rounded-lg">
                        <p class="font-bold text-yellow-700 mb-2">ğŸ’¡ å…¶ä»–é‡è¦æç¤ºï¼š</p>
                        <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                            <li>ç¨‹å¼ç¢¼ä¸­çš„ <code>FormApp.getActiveForm()</code> æœƒè‡ªå‹•ç¶å®šåˆ°æ‚¨ç•¶å‰é–‹å•Ÿçš„è¡¨å–®ã€‚</li>
                            <li>æ‚¨å¯ä»¥æ ¹æ“šéœ€æ±‚ä¿®æ”¹ <code>pointsPerQuestion</code> çš„å€¼ä¾†èª¿æ•´æ¯é¡Œåˆ†æ•¸ã€‚</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t-4 border-black flex justify-end space-x-4 bg-gray-100">
                <button id="gas-instructions-modal-cancel" class="pop-button bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded-lg">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
    const app = {
        db: null,
        questionBanks: [],
        selectedBankIds: new Set(),
        currentQuiz: [],
        editingBankId: null,
        settings: {
            aiSource: 'default', // 'default', 'gemini_api', 'ollama'
            geminiApiKey: '',
            ollamaUrl: 'http://localhost:11434',
            ollamaModel: ''
        },

        init() {
            if (window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            this.loadSettings();
            this.initDB();
            this.addEventListeners();
        },

        initDB() {
            const request = indexedDB.open('QuizGeneratorDB', 1);
            request.onerror = (event) => console.error("Database error: " + event.target.errorCode);
            request.onsuccess = (event) => {
                this.db = event.target.result;
                this.loadBanksFromDB();
            };
            request.onupgradeneeded = (event) => {
                let db = event.target.result;
                let objectStore = db.createObjectStore("questionBanks", { keyPath: "id" });
                objectStore.createIndex("name", "name", { unique: false });
            };
        },

        addEventListeners() {
            document.getElementById('tab-upload').addEventListener('click', () => this.switchTab('upload'));
            document.getElementById('tab-paste').addEventListener('click', () => this.switchTab('paste'));
            document.getElementById('tab-library').addEventListener('click', () => this.switchTab('library'));
            document.getElementById('generate-btn').addEventListener('click', () => this.handleGenerateClick());
            
            // AI Gen Tabs
            document.getElementById('tab-gen-knowledge').addEventListener('click', () => this.switchAIGenTab('knowledge'));
            document.getElementById('tab-gen-comprehension').addEventListener('click', () => this.switchAIGenTab('comprehension'));

            // ç”Ÿæˆç·´ç¿’é¡ŒæŒ‰éˆ•
            document.getElementById('generate-quiz-btn-auto').addEventListener('click', () => this.generatePracticeQuiz('auto'));
            document.getElementById('generate-quiz-btn-manual').addEventListener('click', () => this.generatePracticeQuiz('manual'));
            
            // åŒ¯å‡ºæŒ‰éˆ•
            document.getElementById('export-wordwall-btn').addEventListener('click', () => this.exportQuiz('wordwall'));
            document.getElementById('export-kahoot-btn').addEventListener('click', () => this.exportQuiz('kahoot'));
            document.getElementById('export-publisher-btn').addEventListener('click', () => this.exportQuiz('publisher'));
            document.getElementById('export-wayground-btn').addEventListener('click', () => this.exportQuiz('wayground'));
            document.getElementById('export-google-forms-btn').addEventListener('click', () => this.exportGoogleForms());
            document.getElementById('export-game-btn').addEventListener('click', () => this.openGameSelectModal());

            // è³‡æ–™ç®¡ç†
            document.getElementById('export-data-btn').addEventListener('click', () => this.exportAllData());
            document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', (event) => this.importAllData(event));

            // Modal æŒ‰éˆ•
            document.getElementById('edit-modal-cancel').addEventListener('click', () => this.closeEditModal());
            document.getElementById('edit-modal-save').addEventListener('click', () => this.saveBankEdits());
            document.getElementById('manual-select-cancel').addEventListener('click', () => this.closeManualSelectModal());
            document.getElementById('manual-select-done').addEventListener('click', () => this.generateManualQuiz());

            // æ‰‹å‹•æ–°å¢é¡Œç›® Modal æŒ‰éˆ•
            document.getElementById('add-questions-cancel').addEventListener('click', () => this.closeAddQuestionsModal());
            document.getElementById('add-questions-save').addEventListener('click', () => this.saveNewQuestions());
            document.getElementById('new-question-type').addEventListener('change', () => this.updateDifficultyOptions());

            // æ–°çš„ä¸»æŒ‰éˆ•
            document.getElementById('open-material-modal').addEventListener('click', () => this.openMaterialModal());
            document.getElementById('open-batch-add-modal').addEventListener('click', () => this.openAddQuestionsModal());
            document.getElementById('open-data-modal').addEventListener('click', () => this.openDataModal());

            // æ–°å¢æ•™æ Modal æŒ‰éˆ•
            document.getElementById('material-modal-cancel').addEventListener('click', () => this.closeMaterialModal());

            // è³‡æ–™ç®¡ç† Modal æŒ‰éˆ•
            document.getElementById('data-modal-cancel').addEventListener('click', () => this.closeDataModal());

            // éŠæˆ²é¸æ“‡ Modal æŒ‰éˆ•
            document.getElementById('game-select-cancel').addEventListener('click', () => this.closeGameSelectModal());

            // Google Forms Modal æŒ‰éˆ•
            document.getElementById('google-forms-modal-cancel').addEventListener('click', () => this.closeGoogleFormsModal());
            document.getElementById('copy-gas-code-btn').addEventListener('click', () => this.copyGasCode());
            document.getElementById('gas-instructions-btn').addEventListener('click', () => this.openGasInstructionsModal());
            document.getElementById('gas-instructions-modal-cancel').addEventListener('click', () => this.closeGasInstructionsModal());

            // è¨­å®š Modal æŒ‰éˆ•
            document.getElementById('settings-btn').addEventListener('click', () => this.openSettingsModal());
            document.getElementById('settings-cancel').addEventListener('click', () => this.closeSettingsModal());
            document.getElementById('settings-save').addEventListener('click', () => this.handleSaveSettings());
            document.querySelectorAll('input[name="ai-source"]').forEach(radio => {
                radio.addEventListener('change', () => this.updateSettingsUI());
            });
            document.getElementById('fetch-ollama-models-btn').addEventListener('click', () => this.fetchOllamaModels());

            // æª”æ¡ˆä¸Šå‚³è‡ªå‹•å¡«å…¥åç¨±
            document.getElementById('file-input').addEventListener('change', (event) => this.handleFileUpload(event));
        },
        
        loadSettings() {
            const savedSettings = localStorage.getItem('aiQuizGeneratorSettings');
            if (savedSettings) {
                this.settings = JSON.parse(savedSettings);
            }
        },

        handleSaveSettings() {
            this.settings.aiSource = document.querySelector('input[name="ai-source"]:checked').value;
            this.settings.geminiApiKey = document.getElementById('gemini-api-key').value.trim();
            this.settings.ollamaUrl = document.getElementById('ollama-url').value.trim();
            this.settings.ollamaModel = document.getElementById('ollama-model').value;
            localStorage.setItem('aiQuizGeneratorSettings', JSON.stringify(this.settings));
            alert('è¨­å®šå·²å„²å­˜ï¼');
            this.closeSettingsModal();
        },
        
        openSettingsModal() {
            document.querySelector(`input[name="ai-source"][value="${this.settings.aiSource}"]`).checked = true;
            document.getElementById('gemini-api-key').value = this.settings.geminiApiKey;
            document.getElementById('ollama-url').value = this.settings.ollamaUrl;
            
            const modelSelect = document.getElementById('ollama-model');
            modelSelect.innerHTML = `<option value="">è«‹å…ˆç²å–æ¨¡å‹åˆ—è¡¨</option>`;
            if (this.settings.aiSource === 'ollama' && this.settings.ollamaModel) {
                modelSelect.innerHTML = `<option value="${this.settings.ollamaModel}" selected>${this.settings.ollamaModel}</option>`;
            }

            this.updateSettingsUI();
            document.getElementById('settings-modal').classList.replace('hidden', 'flex');
        },

        closeSettingsModal() {
            document.getElementById('settings-modal').classList.replace('flex', 'hidden');
        },

        updateSettingsUI() {
            const source = document.querySelector('input[name="ai-source"]:checked').value;
            document.getElementById('gemini-api-settings').classList.toggle('hidden', source !== 'gemini_api');
            document.getElementById('ollama-settings').classList.toggle('hidden', source !== 'ollama');
        },

        handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // å–å¾—æª”æ¡ˆåç¨±ï¼Œå»é™¤å‰¯æª”å
                const fileName = file.name.replace(/\.[^/.]+$/, '');
                const bankNameInput = document.getElementById('bank-name');

                // å¦‚æœåç¨±æ¬„ä½ç‚ºç©ºï¼Œè‡ªå‹•å¡«å…¥æª”æ¡ˆåç¨±
                if (!bankNameInput.value.trim()) {
                    bankNameInput.value = fileName;
                }
            }
        },

        async fetchOllamaModels() {
            const url = document.getElementById('ollama-url').value.trim();
            if (!url) {
                alert('è«‹å…ˆè¼¸å…¥ Ollama URLã€‚');
                return;
            }
            const statusEl = document.getElementById('ollama-status');
            const selectEl = document.getElementById('ollama-model');
            statusEl.textContent = 'æ­£åœ¨ç²å–æ¨¡å‹...';
            selectEl.innerHTML = '';
            
            try {
                const response = await fetch(`${url}/api/tags`);
                if (!response.ok) throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${response.status}`);
                const data = await response.json();
                
                if (!data.models || data.models.length === 0) {
                    statusEl.textContent = 'æ‰¾ä¸åˆ°ä»»ä½•æ¨¡å‹ã€‚';
                    selectEl.innerHTML = '<option value="">æ‰¾ä¸åˆ°æ¨¡å‹</option>';
                    return;
                }

                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    selectEl.appendChild(option);
                });
                
                if(this.settings.ollamaModel) {
                    selectEl.value = this.settings.ollamaModel;
                }

                statusEl.textContent = `æˆåŠŸæ‰¾åˆ° ${data.models.length} å€‹æ¨¡å‹ï¼`;

            } catch (error) {
                console.error("Fetch Ollama Models Error:", error);
                statusEl.textContent = `ç²å–å¤±æ•—: ${error.message}`;
                selectEl.innerHTML = '<option value="">ç²å–å¤±æ•—</option>';
            }
        },

        switchTab(tab) {
            const contentUpload = document.getElementById('content-upload');
            const contentPaste = document.getElementById('content-paste');
            const contentLibrary = document.getElementById('content-library');
            const tabUpload = document.getElementById('tab-upload');
            const tabPaste = document.getElementById('tab-paste');
            const tabLibrary = document.getElementById('tab-library');

            // éš±è—æ‰€æœ‰å…§å®¹é¢æ¿
            contentUpload.classList.add('hidden');
            contentPaste.classList.add('hidden');
            contentLibrary.classList.add('hidden');

            // ç§»é™¤æ‰€æœ‰é¸é …å¡çš„ active ç‹€æ…‹
            tabUpload.classList.remove('active');
            tabPaste.classList.remove('active');
            tabLibrary.classList.remove('active');

            // é¡¯ç¤ºé¸ä¸­çš„å…§å®¹é¢æ¿å’Œè¨­ç½®å°æ‡‰é¸é …å¡ç‚º active
            if (tab === 'upload') {
                contentUpload.classList.remove('hidden');
                tabUpload.classList.add('active');
            } else if (tab === 'paste') {
                contentPaste.classList.remove('hidden');
                tabPaste.classList.add('active');
            } else if (tab === 'library') {
                contentLibrary.classList.remove('hidden');
                tabLibrary.classList.add('active');
                this.loadMaterialLibrary(); // è¼‰å…¥æ•™æåº«
            }
        },

        switchAIGenTab(tab) {
            const contentKnowledge = document.getElementById('content-gen-knowledge');
            const contentComprehension = document.getElementById('content-gen-comprehension');
            const tabKnowledge = document.getElementById('tab-gen-knowledge');
            const tabComprehension = document.getElementById('tab-gen-comprehension');

            if (tab === 'knowledge') {
                contentKnowledge.classList.remove('hidden');
                contentComprehension.classList.add('hidden');
                tabKnowledge.classList.add('active');
                tabComprehension.classList.remove('active');
            } else {
                contentKnowledge.classList.add('hidden');
                contentComprehension.classList.remove('hidden');
                tabKnowledge.classList.remove('active');
                tabComprehension.classList.add('active');
            }
        },
        
        showLoading(message) {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-modal').classList.remove('hidden');
        },
        
        hideLoading() {
            document.getElementById('loading-modal').classList.add('hidden');
        },

        async handleGenerateClick() {
            const bankName = document.getElementById('bank-name').value.trim();
            if (!bankName) {
                alert('è«‹ç‚ºæ‚¨çš„æ•™æå‘½åï¼');
                return;
            }

            let textContent = '';
            const fileInput = document.getElementById('file-input').files[0];
            const textInput = document.getElementById('text-input').value.trim();

            // ç«‹å³é—œé–‰æ–°å¢æ•™æ Modal
            this.closeMaterialModal();

            this.showLoading('æ­£åœ¨è®€å–èˆ‡åˆ†æå…§å®¹...');

            try {
                if (fileInput) {
                    if (fileInput.type === 'application/pdf') {
                        textContent = await this.readPdf(fileInput);
                    } else if (fileInput.type === 'text/plain') {
                        textContent = await this.readFileAsText(fileInput);
                    } else {
                        throw new Error('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ã€‚');
                    }
                } else if (textInput) {
                    textContent = textInput;
                } else {
                    throw new Error('è«‹æä¾›æ•™æå…§å®¹ï¼');
                }

                if (textContent.length < 50) {
                     throw new Error('å…§å®¹å¤ªçŸ­ï¼Œè«‹æä¾›è‡³å°‘50å€‹å­—å…ƒã€‚');
                }
                
                const genMode = document.getElementById('tab-gen-knowledge').classList.contains('active') ? 'knowledge' : 'comprehension';
                
                let genParams = {};
                if (genMode === 'knowledge') {
                    genParams = {
                        easy: document.getElementById('num-easy').value,
                        medium: document.getElementById('num-medium').value,
                        hard: document.getElementById('num-hard').value,
                    };
                } else {
                    genParams = {
                        level1: document.getElementById('num-comp-1').value,
                        level2: document.getElementById('num-comp-2').value,
                        level3: document.getElementById('num-comp-3').value,
                        level4: document.getElementById('num-comp-4').value,
                    };
                }

                this.showLoading('å…§å®¹åˆ†æå®Œæˆï¼Œæ­£åœ¨å‘¼å« AI ç”Ÿæˆé¡Œç›®...');
                const aiResponse = await this.callAIAPI(textContent, genMode, genParams);
                
                const newBank = {
                    id: `bank-${Date.now()}`,
                    name: bankName,
                    sourceText: textContent,
                    ...aiResponse
                };
                
                this.saveBankToDB(newBank, true);

            } catch (error) {
                console.error("Generation Error:", error);
                alert(`ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
            } finally {
                this.hideLoading();
            }
        },

        async callAIAPI(text, genMode, genParams) {
            switch (this.settings.aiSource) {
                case 'gemini_api':
                    return this.callGemini(text, genMode, genParams);
                case 'ollama':
                    return this.callOllama(text, genMode, genParams);
                case 'default':
                default:
                    return this.callGemini(text, genMode, genParams);
            }
        },

        async callGemini(text, genMode, genParams) {
            let apiKey = "";
            if (this.settings.aiSource === 'gemini_api') {
                apiKey = this.settings.geminiApiKey;
                if (!apiKey) {
                    throw new Error('å°šæœªè¨­å®š Gemini API Keyã€‚è«‹åœ¨è¨­å®šä¸­è¼¸å…¥ã€‚');
                }
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            let systemPrompt = '';

            if (genMode === 'knowledge') {
                systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ•™è‚²å…§å®¹ç”¢ç”Ÿå™¨ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…æä¾›çš„æ–‡æœ¬å…§å®¹ï¼ŒåŸ·è¡Œä»¥ä¸‹ä»»å‹™ï¼š

**ä»»å‹™èªªæ˜ï¼š**
1. ä»”ç´°åˆ†ææä¾›çš„æ–‡æœ¬å…§å®¹ï¼ŒåŒ…æ‹¬ä½†ä¸é™æ–¼ï¼šçŸ¥è­˜é»è¬›è§£ã€æ¦‚å¿µä»‹ç´¹ã€å®šç¾©èªªæ˜ã€æ¡ˆä¾‹åˆ†æã€æ“ä½œæ­¥é©Ÿç­‰ã€‚
2. æ ¹æ“šæ–‡æœ¬çš„ä¸»é¡Œå’Œå…§å®¹ç‰¹æ€§ï¼Œå°‡å…¶æ­¸ç´æˆ2-5å€‹ä¸»è¦é¡åˆ¥æˆ–çŸ¥è­˜æ¨¡çµ„ã€‚
3. åŸºæ–¼æ–‡æœ¬å…§å®¹ç”Ÿæˆé«˜å“è³ªçš„å–®é¸é¸æ“‡é¡Œï¼Œæ•¸é‡åˆ†é…å¦‚ä¸‹ï¼š
   - ç°¡å–® (Easy): ${genParams.easy} é¡Œ - ä¸»è¦æ¸¬è©¦åŸºæœ¬æ¦‚å¿µç†è§£å’Œè¨˜æ†¶
   - ä¸­ç­‰ (Medium): ${genParams.medium} é¡Œ - æ¸¬è©¦æ¦‚å¿µæ‡‰ç”¨å’Œç†è§£
   - å›°é›£ (Hard): ${genParams.hard} é¡Œ - æ¸¬è©¦æ·±åº¦åˆ†æå’Œç¶œåˆåˆ¤æ–·

**é¡Œç›®ç”Ÿæˆè¦æ±‚ï¼š**
- æ¯é¡Œå¿…é ˆæœ‰4å€‹é¸é …ï¼Œå…¶ä¸­åªæœ‰1å€‹æ­£ç¢ºç­”æ¡ˆ
- é¡Œç›®å…§å®¹å¿…é ˆå®Œå…¨åŸºæ–¼æä¾›çš„æ–‡æœ¬ï¼Œä¸å¯æ·»åŠ æ–‡æœ¬å¤–çš„è³‡è¨Š
- é¸é …è¨­è¨ˆè¦å…·æœ‰è¿·æƒ‘æ€§ï¼Œé¿å…éæ–¼æ˜é¡¯çš„éŒ¯èª¤é¸é …
- é¡Œç›®ç”¨è©è¦æ¸…æ™°æº–ç¢ºï¼Œé¿å…æ­§ç¾©
- å¦‚æœæ–‡æœ¬å…§å®¹ä¸è¶³ä»¥ç”ŸæˆæŒ‡å®šæ•¸é‡çš„æŸé›£åº¦é¡Œç›®ï¼Œè«‹èª¿æ•´åˆ°å…¶ä»–é›£åº¦æˆ–æ¸›å°‘ç¸½é¡Œæ•¸

**è¼¸å‡ºæ ¼å¼ï¼š**
åš´æ ¼æŒ‰ç…§ JSON æ ¼å¼å›å‚³ï¼Œä¸åŒ…å«ä»»ä½•ç¨‹å¼ç¢¼æ¨™è¨˜æˆ–é¡å¤–æ–‡å­—ã€‚'difficulty' æ¬„ä½å¿…é ˆä½¿ç”¨ï¼š'Easy', 'Medium', 'Hard'ã€‚`;
            } else {
                systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„é–±è®€ç†è§£æ¸¬é©—è¨­è¨ˆå°ˆå®¶ï¼Œç†Ÿæ‚‰ PISA åœ‹éš›å­¸ç”Ÿèƒ½åŠ›è©•é‡æ¨™æº–ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…æä¾›çš„æ–‡æœ¬å…§å®¹ï¼ŒåŸ·è¡Œä»¥ä¸‹ä»»å‹™ï¼š

**æ–‡æœ¬åˆ†æï¼š**
1. æ·±å…¥åˆ†ææä¾›çš„æ–‡æœ¬å…§å®¹ï¼ŒåŒ…æ‹¬ï¼šæ–‡ç« çµæ§‹ã€ä¸»è¦è«–é»ã€æ”¯æŒè­‰æ“šã€ä½œè€…è§€é»ã€æ–‡æœ¬é¡å‹ï¼ˆèªªæ˜æ–‡ã€è­°è«–æ–‡ã€è¨˜æ•˜æ–‡ç­‰ï¼‰ã€‚
2. æ ¹æ“šæ–‡æœ¬çš„ä¸»é¡Œå’Œæ®µè½çµæ§‹ï¼Œå°‡å…§å®¹æ­¸ç´æˆ2-5å€‹ä¸»è¦é¡åˆ¥æˆ–é–±è®€é‡é»ã€‚

**é¡Œç›®ç”Ÿæˆæ¨™æº–ï¼ˆåŸºæ–¼ PISA å››å±¤æ¬¡ï¼‰ï¼š**
- **æå–è¨Šæ¯ (${genParams.level1} é¡Œ)**ï¼šç›´æ¥å¾æ–‡æœ¬ä¸­æ‰¾åˆ°æ˜ç¢ºé™³è¿°çš„è³‡è¨Šã€äº‹å¯¦ã€æ•¸æ“šæˆ–ç´°ç¯€
- **æ–‡æ„æ¨è«– (${genParams.level2} é¡Œ)**ï¼šæ ¹æ“šæ–‡æœ¬å…§å®¹é€²è¡Œé‚è¼¯æ¨ç†ï¼Œç†è§£éš±å«æ„ç¾©æˆ–å› æœé—œä¿‚
- **è©®é‡‹æ•´åˆ (${genParams.level3} é¡Œ)**ï¼šæ•´åˆæ–‡æœ¬ä¸åŒéƒ¨åˆ†çš„è³‡è¨Šï¼Œç†è§£æ•´é«”æ„ç¾©å’Œçµæ§‹é—œä¿‚
- **åæ€è©•åƒ¹ (${genParams.level4} é¡Œ)**ï¼šè©•åˆ¤æ–‡æœ¬å…§å®¹çš„å¯ä¿¡åº¦ã€é‚è¼¯æ€§ï¼Œæˆ–èˆ‡å¤–éƒ¨çŸ¥è­˜çš„é€£çµ

**é¡Œç›®è¨­è¨ˆè¦æ±‚ï¼š**
- æ¯é¡Œ4å€‹é¸é …ï¼Œç­”æ¡ˆå”¯ä¸€ä¸”æ˜ç¢º
- é¸é …è¨­è¨ˆè¦ç¬¦åˆè©²å±¤æ¬¡çš„èªçŸ¥è¦æ±‚
- å¹²æ“¾é¸é …è¦åˆç†ä½†å¯è¾¨åˆ¥
- é¡Œç›®èªè¨€è¦é©åˆç›®æ¨™è®€è€…
- åš´æ ¼åŸºæ–¼æ–‡æœ¬å…§å®¹ï¼Œä¸å¯è¶…å‡ºæ–‡æœ¬ç¯„åœ
- å¦‚å…§å®¹ä¸è¶³ï¼Œå„ªå…ˆä¿è­‰é¡Œç›®å“è³ªè€Œéæ•¸é‡

**è¼¸å‡ºè¦æ±‚ï¼š**
å›å‚³æ¨™æº– JSON æ ¼å¼ï¼Œ'difficulty' æ¬„ä½ä½¿ç”¨ï¼š'æå–è¨Šæ¯', 'æ–‡æ„æ¨è«–', 'è©®é‡‹æ•´åˆ', 'åæ€è©•åƒ¹'ã€‚`;
            }
            const payload = {
                systemInstruction: { parts: [{ text: systemPrompt }] },
                contents: [{ parts: [{ text: `è«‹åˆ†æé€™æ®µæ–‡æœ¬ï¼š\n\n${text}` }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            categories: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        questions: {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: {
                                                    questionText: { type: "STRING" },
                                                    options: { type: "ARRAY", items: { type: "STRING" } },
                                                    correctAnswerIndex: { type: "NUMBER" },
                                                    difficulty: { 
                                                        type: "STRING", 
                                                        enum: ["Easy", "Medium", "Hard", "æå–è¨Šæ¯", "æ–‡æ„æ¨è«–", "è©®é‡‹æ•´åˆ", "åæ€è©•åƒ¹"] 
                                                    }
                                                },
                                                required: ["questionText", "options", "correctAnswerIndex", "difficulty"]
                                            }
                                        }
                                    },
                                    required: ["name", "questions"]
                                }
                            }
                        },
                        required: ["categories"]
                    }
                }
            };
            let response;
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount <= maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // æˆåŠŸï¼Œè·³å‡ºé‡è©¦å¾ªç’°
                    }

                    if (response.status === 503 && retryCount < maxRetries) {
                        // 503 æœå‹™ä¸å¯ç”¨ï¼Œç­‰å¾…å¾Œé‡è©¦
                        const waitTime = Math.pow(2, retryCount) * 1000; // æŒ‡æ•¸é€€é¿: 1s, 2s, 4s
                        console.warn(`AI API æœå‹™æš«æ™‚ä¸å¯ç”¨ (503)ï¼Œ${waitTime/1000}ç§’å¾Œé‡è©¦...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        retryCount++;
                        continue;
                    }

                    // å…¶ä»–éŒ¯èª¤æˆ–é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸
                    throw new Error(`AI API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}${response.status === 503 ? 'ï¼Œæœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦' : ''}`);

                } catch (error) {
                    if (error.name === 'TypeError' && retryCount < maxRetries) {
                        // ç¶²è·¯éŒ¯èª¤ï¼Œé‡è©¦
                        const waitTime = Math.pow(2, retryCount) * 1000;
                        console.warn(`ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œ${waitTime/1000}ç§’å¾Œé‡è©¦...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        retryCount++;
                        continue;
                    }
                    throw error;
                }
            }
            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (!candidate || !candidate.content?.parts?.[0]?.text) {
                throw new Error("AI å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚");
            }
            try {
                const cleanedText = candidate.content.parts[0].text.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                return JSON.parse(cleanedText);
            } catch (e) {
                throw new Error("ç„¡æ³•è§£æ AI å›å‚³çš„ JSON è³‡æ–™ã€‚");
            }
        },

        async callOllama(text, genMode, genParams) {
            const { ollamaUrl, ollamaModel } = this.settings;
            if (!ollamaUrl || !ollamaModel) {
                throw new Error('å°šæœªè¨­å®š Ollama URL æˆ–é¸æ“‡æ¨¡å‹ã€‚');
            }
            const apiUrl = `${ollamaUrl}/api/generate`;
            let systemPrompt = '';
            if (genMode === 'knowledge') {
                systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ•™è‚²å…§å®¹ç”¢ç”Ÿå™¨ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„æ–‡æœ¬ç”ŸæˆæŒ‡å®šæ•¸é‡çš„JSONæ ¼å¼é¸æ“‡é¡Œã€‚è«‹éµå¾ªä»¥ä¸‹è¦å‰‡ï¼š1. è‡ªå‹•å°‡æ–‡æœ¬å…§å®¹æ­¸ç´æˆæ•¸å€‹ä¸»è¦é¡åˆ¥ã€‚2. æ ¹æ“šä»¥ä¸‹æŒ‡å®šæ•¸é‡ï¼Œç”Ÿæˆä¸åŒé›£åº¦çš„å–®é¸é¸æ“‡é¡Œï¼š - ç°¡å–® (Easy): ${genParams.easy} é¡Œ, - ä¸­ç­‰ (Medium): ${genParams.medium} é¡Œ, - å›°é›£ (Hard): ${genParams.hard} é¡Œã€‚3. æ¯å€‹å•é¡Œå¿…é ˆæœ‰å››å€‹é¸é …å’Œä¸€å€‹æ­£ç¢ºç­”æ¡ˆç´¢å¼•ã€‚4. æ‰€æœ‰å…§å®¹å¿…é ˆå®Œå…¨åŸºæ–¼æä¾›çš„æ–‡æœ¬ã€‚5. åœ¨ 'difficulty' æ¬„ä½ä¸­ï¼Œå¿…é ˆä½¿ç”¨ 'Easy', 'Medium', æˆ– 'Hard'ã€‚6. ä½ çš„å›ç­”å¿…é ˆæ˜¯å–®ä¸€ä¸”æ ¼å¼æ­£ç¢ºçš„JSONç‰©ä»¶ï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—ã€‚`;
            } else {
                systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ•™è‚²å…§å®¹ç”¢ç”Ÿå™¨ï¼Œå°ˆé•·æ˜¯PISAé–±è®€ç†è§£é¡Œç›®è¨­è¨ˆã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„æ–‡æœ¬ç”ŸæˆæŒ‡å®šæ•¸é‡çš„JSONæ ¼å¼é¸æ“‡é¡Œã€‚è«‹éµå¾ªä»¥ä¸‹è¦å‰‡ï¼š1. è‡ªå‹•å°‡æ–‡æœ¬å…§å®¹æ­¸ç´æˆæ•¸å€‹ä¸»è¦é¡åˆ¥ã€‚2. æ ¹æ“šPISAé–±è®€ç†è§£å››å€‹å±¤æ¬¡åŠä»¥ä¸‹æ•¸é‡å‡ºé¡Œï¼š - æå–è¨Šæ¯: ${genParams.level1} é¡Œ, - æ–‡æ„æ¨è«–: ${genParams.level2} é¡Œ, - è©®é‡‹æ•´åˆ: ${genParams.level3} é¡Œ, - åæ€è©•åƒ¹: ${genParams.level4} é¡Œã€‚3. æ¯å€‹å•é¡Œå¿…é ˆæœ‰å››å€‹é¸é …å’Œä¸€å€‹æ­£ç¢ºç­”æ¡ˆç´¢å¼•ã€‚4. æ‰€æœ‰å…§å®¹å¿…é ˆå®Œå…¨åŸºæ–¼æä¾›çš„æ–‡æœ¬ã€‚5. åœ¨ 'difficulty' æ¬„ä½ä¸­ï¼Œå¿…é ˆä½¿ç”¨å°æ‡‰çš„å±¤æ¬¡åç¨±ã€‚6. ä½ çš„å›ç­”å¿…é ˆæ˜¯å–®ä¸€ä¸”æ ¼å¼æ­£ç¢ºçš„JSONç‰©ä»¶ï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—ã€‚`;
            }

            const fullPrompt = `${systemPrompt}\n\næ–‡æœ¬å…§å®¹å¦‚ä¸‹ï¼š\n\`\`\`\n${text}\n\`\`\`\nè«‹ç”Ÿæˆ JSONï¼š`;
            
            const payload = {
                model: ollamaModel,
                prompt: fullPrompt,
                format: "json",
                stream: false
            };
            const response = await fetch(apiUrl, { method: 'POST', body: JSON.stringify(payload) });
            if (!response.ok) {
                throw new Error(`Ollama API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š${response.status}`);
            }
            const result = await response.json();
            if (!result.response) {
                throw new Error("Ollama å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚");
            }
            try {
                const cleanedText = result.response.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                return JSON.parse(cleanedText);
            } catch (e) {
                throw new Error("ç„¡æ³•è§£æ Ollama å›å‚³çš„ JSON è³‡æ–™ã€‚");
            }
        },

        async readFileAsText(file) { return new Promise((resolve, reject)=>{const reader=new FileReader();reader.onload=event=>resolve(event.target.result);reader.onerror=error=>reject(error);reader.readAsText(file);});},
        async readPdf(file) { const reader=new FileReader();return new Promise((resolve,reject)=>{reader.onload=async(event)=>{const typedarray=new Uint8Array(event.target.result);try{const pdf=await pdfjsLib.getDocument(typedarray).promise;let text='';for(let i=1;i<=pdf.numPages;i++){const page=await pdf.getPage(i);const content=await page.getTextContent();text+=content.items.map(item=>item.str).join(' ')+'\n';}
resolve(text);}catch(error){reject('ç„¡æ³•è§£æ PDF æª”æ¡ˆï¼š'+error.message);}};reader.onerror=reject;reader.readAsArrayBuffer(file);});},

        saveBankToDB(bank, isNew = false) {
            const transaction = this.db.transaction(["questionBanks"], "readwrite");
            const objectStore = transaction.objectStore("questionBanks");
            const request = objectStore.put(bank);
            request.onsuccess = () => {
                if (isNew) this.loadBanksFromDB();
            };
            request.onerror = (event) => console.error("Error saving bank to DB:", event.target.errorCode);
        },

        loadBanksFromDB() {
            this.questionBanks = [];
            const objectStore = this.db.transaction("questionBanks").objectStore("questionBanks");
            objectStore.openCursor().onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    this.questionBanks.push(cursor.value);
                    cursor.continue();
                } else {
                    this.renderBankList();
                }
            };
        },
        
        deleteBank(id) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹é¡Œåº«å—ï¼Ÿ")) return;
            const request = this.db.transaction(["questionBanks"], "readwrite").objectStore("questionBanks").delete(id);
            request.onsuccess = () => {
                this.selectedBankIds.delete(id);
                this.loadBanksFromDB();
            };
        },

        renderBankList() {
            const listEl = document.getElementById('bank-list');
            listEl.innerHTML = this.questionBanks.length === 0 ? '<p class="text-gray-500">å°šæœªå»ºç«‹ä»»ä½•é¡Œåº«ã€‚</p>' : '';
            if (this.questionBanks.length === 0) {
                this.updateQuizButtonState();
                return;
            }

            this.questionBanks.forEach(bank => {
                const totalQuestions = (bank.categories || []).reduce((acc, cat) => acc + (cat.questions || []).length, 0);
                const bankType = this.detectBankType(bank);

                // è¨­å®šé¡Œåº«é¡å‹çš„é¡¯ç¤ºè³‡è¨Š
                let typeInfo = { text: 'æœªçŸ¥é¡å‹', color: 'bg-gray-400', icon: 'â“' };
                if (bankType === 'knowledge') {
                    typeInfo = { text: 'çŸ¥è­˜é»', color: 'bg-blue-400', icon: 'ğŸ“š' };
                } else if (bankType === 'comprehension') {
                    typeInfo = { text: 'é–±è®€ç†è§£', color: 'bg-green-400', icon: 'ğŸ“–' };
                }

                const bankEl = document.createElement('div');
                bankEl.className = 'p-3 bg-white border-2 border-black rounded-lg flex items-center justify-between gap-2';
                bankEl.innerHTML = `
                    <div class="flex items-center flex-grow">
                        <input type="checkbox" data-id="${bank.id}" class="bank-checkbox h-5 w-5 mr-3 flex-shrink-0" ${this.selectedBankIds.has(bank.id) ? 'checked' : ''}>
                        <div class="truncate">
                            <div class="flex items-center gap-2 mb-1">
                                <p class="font-bold truncate">${bank.name}</p>
                                <span class="text-xs font-bold text-white px-2 py-1 rounded border border-black ${typeInfo.color}" style="box-shadow: 2px 2px 0 0 #000;">
                                    ${typeInfo.icon} ${typeInfo.text}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500">${(bank.categories || []).length} å€‹åˆ†é¡, ${totalQuestions} é¡Œ</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button data-id="${bank.id}" class="edit-bank-btn text-sm pop-button bg-yellow-200 hover:bg-yellow-300 px-2 py-1 rounded">é è¦½/ç·¨è¼¯</button>
                        <button data-id="${bank.id}" class="delete-bank-btn pop-button bg-red-400 hover:bg-red-500 text-white font-bold w-8 h-8 rounded">X</button>
                    </div>
                `;
                listEl.appendChild(bankEl);
            });

            this.updateQuizButtonState();
            this.updateOtherBankStates();

            document.querySelectorAll('.bank-checkbox').forEach(cb => cb.addEventListener('change', (e) => {
                const id = e.target.dataset.id;
                const bank = this.questionBanks.find(b => b.id === id);

                if (e.target.checked) {
                    // æª¢æŸ¥æ˜¯å¦å¯ä»¥æ·»åŠ é€™å€‹é¡Œåº«
                    if (this.canSelectBank(bank)) {
                        this.selectedBankIds.add(id);
                        this.updateOtherBankStates();
                    } else {
                        // ä¸èƒ½é¸æ“‡ï¼Œå–æ¶ˆå‹¾é¸
                        e.target.checked = false;
                        const selectedTypes = this.getSelectedBankTypes();
                        const bankType = this.detectBankType(bank);
                        const typeNames = {
                            'knowledge': 'çŸ¥è­˜é»é¡Œåº«',
                            'comprehension': 'é–±è®€ç†è§£é¡Œåº«'
                        };

                        if (selectedTypes.size > 0) {
                            const selectedTypeName = typeNames[Array.from(selectedTypes)[0]];
                            const attemptTypeName = typeNames[bankType];
                            alert(`ç„¡æ³•åŒæ™‚é¸æ“‡ä¸åŒé¡å‹çš„é¡Œåº«ï¼\nç›®å‰å·²é¸ï¼š${selectedTypeName}\nå˜—è©¦é¸æ“‡ï¼š${attemptTypeName}\n\nè«‹å…ˆå–æ¶ˆå…¶ä»–é¡å‹çš„é¡Œåº«é¸æ“‡ã€‚`);
                        }
                    }
                } else {
                    this.selectedBankIds.delete(id);
                    this.updateOtherBankStates();
                }
                this.updateQuizButtonState();
            }));
            document.querySelectorAll('.delete-bank-btn').forEach(btn => btn.addEventListener('click', (e) => this.deleteBank(e.target.dataset.id)));
            document.querySelectorAll('.edit-bank-btn').forEach(btn => btn.addEventListener('click', (e) => this.openEditModal(e.target.dataset.id)));
        },

        // æª¢æŸ¥æ˜¯å¦å¯ä»¥é¸æ“‡æŒ‡å®šé¡Œåº«
        canSelectBank(bank) {
            const selectedTypes = this.getSelectedBankTypes();
            const bankType = this.detectBankType(bank);

            // å¦‚æœæ²’æœ‰é¸æ“‡ä»»ä½•é¡Œåº«ï¼Œå¯ä»¥é¸æ“‡
            if (selectedTypes.size === 0) return true;

            // å¦‚æœé¡Œåº«é¡å‹ç„¡æ³•æª¢æ¸¬ï¼Œä¸å…è¨±é¸æ“‡
            if (!bankType) return false;

            // å¦‚æœå·²é¸æ“‡çš„é¡Œåº«é¡å‹èˆ‡ç•¶å‰é¡Œåº«é¡å‹ç›¸åŒï¼Œå¯ä»¥é¸æ“‡
            return selectedTypes.has(bankType);
        },

        // æ›´æ–°å…¶ä»–é¡Œåº«çš„å¯é¸ç‹€æ…‹
        updateOtherBankStates() {
            const selectedTypes = this.getSelectedBankTypes();

            document.querySelectorAll('.bank-checkbox').forEach(cb => {
                const id = cb.dataset.id;
                const bank = this.questionBanks.find(b => b.id === id);
                const bankType = this.detectBankType(bank);

                // å¦‚æœæ²’æœ‰é¸æ“‡ä»»ä½•é¡Œåº«ï¼Œæ‰€æœ‰é¡Œåº«éƒ½å¯é¸
                if (selectedTypes.size === 0) {
                    cb.disabled = false;
                    cb.parentElement.parentElement.style.opacity = '1';
                    return;
                }

                // å¦‚æœå·²ç¶“é¸ä¸­ï¼Œä¿æŒå¯ç”¨
                if (cb.checked) {
                    cb.disabled = false;
                    cb.parentElement.parentElement.style.opacity = '1';
                    return;
                }

                // å¦‚æœé¡å‹ä¸åŒ¹é…ï¼Œç¦ç”¨
                if (!bankType || !selectedTypes.has(bankType)) {
                    cb.disabled = true;
                    cb.parentElement.parentElement.style.opacity = '0.5';
                } else {
                    cb.disabled = false;
                    cb.parentElement.parentElement.style.opacity = '1';
                }
            });
        },

        // æª¢æ¸¬é¡Œåº«é¡å‹ï¼ˆæ ¹æ“šé›£åº¦æ¨™ç±¤åˆ¤æ–·ï¼‰
        detectBankType(bank) {
            if (!bank.categories || bank.categories.length === 0) return null;

            // æª¢æŸ¥ç¬¬ä¸€å€‹æœ‰é¡Œç›®çš„åˆ†é¡ä¸­çš„ç¬¬ä¸€å€‹é¡Œç›®çš„é›£åº¦
            for (const category of bank.categories) {
                if (category.questions && category.questions.length > 0) {
                    const difficulty = category.questions[0].difficulty;
                    if (['Easy', 'Medium', 'Hard'].includes(difficulty)) {
                        return 'knowledge';
                    } else if (['æå–è¨Šæ¯', 'æ–‡æ„æ¨è«–', 'è©®é‡‹æ•´åˆ', 'åæ€è©•åƒ¹'].includes(difficulty)) {
                        return 'comprehension';
                    }
                }
            }
            return null;
        },

        // ç²å–å·²é¸é¡Œåº«çš„é¡å‹
        getSelectedBankTypes() {
            const types = new Set();
            this.questionBanks.forEach(bank => {
                if (this.selectedBankIds.has(bank.id)) {
                    const type = this.detectBankType(bank);
                    if (type) types.add(type);
                }
            });
            return types;
        },

        // æ›´æ–°é›£åº¦é¸æ“‡UI
        updateDifficultySelectionUI() {
            const selectedTypes = this.getSelectedBankTypes();
            const titleElement = document.getElementById('difficulty-title');
            const optionsElement = document.getElementById('difficulty-options');

            if (!titleElement || !optionsElement) return;

            if (selectedTypes.size === 0) {
                // æ²’æœ‰é¸æ“‡é¡Œåº«ï¼Œé¡¯ç¤ºé è¨­çš„çŸ¥è­˜é»é¸é …
                titleElement.textContent = 'é›£åº¦åå¥½ï¼š';
                optionsElement.innerHTML = `
                    <label><input type="checkbox" class="difficulty-pref" value="Easy" checked> ç°¡å–®</label>
                    <label><input type="checkbox" class="difficulty-pref" value="Medium" checked> ä¸­ç­‰</label>
                    <label><input type="checkbox" class="difficulty-pref" value="Hard" checked> å›°é›£</label>
                `;
                return;
            }

            if (selectedTypes.has('comprehension')) {
                // é–±è®€ç†è§£é¡å‹ï¼Œé¡¯ç¤ºå››å±¤æ¬¡
                titleElement.textContent = 'å±¤æ¬¡åå¥½ï¼š';
                optionsElement.innerHTML = `
                    <label><input type="checkbox" class="difficulty-pref" value="æå–è¨Šæ¯" checked> æå–è¨Šæ¯</label>
                    <label><input type="checkbox" class="difficulty-pref" value="æ–‡æ„æ¨è«–" checked> æ–‡æ„æ¨è«–</label>
                    <label><input type="checkbox" class="difficulty-pref" value="è©®é‡‹æ•´åˆ" checked> è©®é‡‹æ•´åˆ</label>
                    <label><input type="checkbox" class="difficulty-pref" value="åæ€è©•åƒ¹" checked> åæ€è©•åƒ¹</label>
                `;
            } else {
                // çŸ¥è­˜é»é¡å‹ï¼Œé¡¯ç¤ºä¸‰é›£åº¦
                titleElement.textContent = 'é›£åº¦åå¥½ï¼š';
                optionsElement.innerHTML = `
                    <label><input type="checkbox" class="difficulty-pref" value="Easy" checked> ç°¡å–®</label>
                    <label><input type="checkbox" class="difficulty-pref" value="Medium" checked> ä¸­ç­‰</label>
                    <label><input type="checkbox" class="difficulty-pref" value="Hard" checked> å›°é›£</label>
                `;
            }
        },

        updateQuizButtonState() {
            const disabled = this.selectedBankIds.size === 0;
            document.getElementById('generate-quiz-btn-auto').disabled = disabled;
            document.getElementById('generate-quiz-btn-manual').disabled = disabled;

            // æ›´æ–°é›£åº¦é¸æ“‡UI
            this.updateDifficultySelectionUI();
        },

        generatePracticeQuiz(mode) {
            if (this.selectedBankIds.size === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡Œåº«ï¼");
            if (mode === 'auto') {
                const numQuestions = parseInt(document.getElementById('num-questions').value, 10);
                const difficultyPrefs = [...document.querySelectorAll('.difficulty-pref:checked')].map(el => el.value);
                let allAvailableQuestions = [];
                this.questionBanks.forEach(bank => {
                    if (this.selectedBankIds.has(bank.id)) {
                        bank.categories.forEach(cat => {
                            allAvailableQuestions.push(...cat.questions);
                        });
                    }
                });
                let filteredQuestions = allAvailableQuestions.filter(q => difficultyPrefs.includes(q.difficulty));
                if (filteredQuestions.length === 0) return alert("æ ¹æ“šæ‚¨é¸æ“‡çš„é›£åº¦ï¼Œæ‰¾ä¸åˆ°ç¬¦åˆçš„é¡Œç›®ã€‚è«‹æ³¨æ„ï¼Œæ­¤ç¯©é¸ä¸é©ç”¨æ–¼é–±è®€ç†è§£é¡Œå‹ã€‚");
                this.currentQuiz = filteredQuestions.sort(() => 0.5 - Math.random()).slice(0, numQuestions);
                this.renderQuizPreview();
            } else if (mode === 'manual') {
                this.openManualSelectModal();
            }
        },

        renderQuizPreview() { const previewEl=document.getElementById('quiz-preview');const listEl=document.getElementById('quiz-preview-list');if(this.currentQuiz.length===0){previewEl.classList.add('hidden');return;}
listEl.innerHTML='';this.currentQuiz.forEach((q,index)=>{const optionsHtml=q.options.map((opt,i)=>`
                    <li class="${i===q.correctAnswerIndex?'font-bold text-green-700':''}">
                        ${String.fromCharCode(65+i)}. ${opt}
                    </li>
                `).join('');const questionEl=document.createElement('div');questionEl.className='mb-4 pb-4 border-b border-dashed border-gray-400';questionEl.innerHTML=`
                    <p class="font-bold">${index+1}. ${q.questionText} <span class="text-sm font-normal text-blue-600">(${q.difficulty})</span></p>
                    <ul class="list-none pl-4 mt-2">
                        ${optionsHtml}
                    </ul>
                `;listEl.appendChild(questionEl);});previewEl.classList.remove('hidden');},
        
        exportQuiz(format) { if(this.currentQuiz.length===0){alert("æ²’æœ‰å¯åŒ¯å‡ºçš„ç·´ç¿’é¡Œã€‚");return;}
let csvContent="";const separator='\t';this.currentQuiz.forEach(q=>{const question=q.questionText;const options=q.options.map(opt=>opt);const answer=q.correctAnswerIndex+1;while(options.length<4){options.push('');}
let row;if(format==='wordwall'){row=[question,...options.slice(0,4),answer].join(separator);}else if(format==='kahoot'){const timeLimit=60;row=[question,...options.slice(0,4),timeLimit,answer].join(separator);}else if(format==='wayground'){row=[question,'Multiple Choice',...options.slice(0,4),'',answer].join(separator);}else{row=[question,answer,...options.slice(0,4)].join(separator);}
csvContent+=row+"\r\n";});this.downloadFile(csvContent,`quiz_${format}_${Date.now()}.txt`,'text/plain;charset=utf-8;');},

        downloadFile(content, fileName, contentType) { const blob=new Blob([`\uFEFF${content}`],{type:contentType});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=fileName;a.click();URL.revokeObjectURL(a.href);},

        // Google Forms åŒ¯å‡ºåŠŸèƒ½
        exportGoogleForms() {
            if(this.currentQuiz.length === 0) {
                alert("æ²’æœ‰å¯åŒ¯å‡ºçš„ç·´ç¿’é¡Œã€‚");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦åŒ…å«é–±è®€ç†è§£é¡å‹çš„é¡Œåº«ï¼Œä¸¦ç²å–åŸå§‹æ–‡æœ¬
            const sourceText = this.getSourceTextForCurrentQuiz();

            // ç”Ÿæˆ GAS ç¨‹å¼ç¢¼
            const gasCode = this.generateGasCode(this.currentQuiz, sourceText);

            // é¡¯ç¤ºåœ¨ modal ä¸­
            document.getElementById('gas-code-content').textContent = gasCode;
            document.getElementById('google-forms-modal').classList.remove('hidden');
            document.getElementById('google-forms-modal').classList.add('flex');
        },

        generateGasCode(questions, sourceText = null) {
            // æ±ºå®šè¡¨å–®æ¨™é¡Œå’Œèªªæ˜å…§å®¹
            let formTitle = 'AI ç”Ÿæˆæ¸¬é©—è¡¨å–®';
            let formDescription = '';

            if (sourceText && sourceText.trim()) {
                // å¦‚æœæœ‰åŸå§‹æ–‡æœ¬ï¼ˆé–±è®€ç†è§£é¡å‹ï¼‰ï¼Œä½¿ç”¨æ–‡æœ¬çš„ç¬¬ä¸€è¡Œä½œç‚ºæ¨™é¡Œ
                const lines = sourceText.trim().split('\n');
                const firstLine = lines[0].trim();
                if (firstLine && firstLine.length < 100) {
                    formTitle = firstLine;
                }
                formDescription = `è«‹é–±è®€ä»¥ä¸‹æ–‡ç« ï¼š\\n\\n${sourceText.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n')}`;
            }

            // åŸºç¤ GAS æ¨¡æ¿
            const gasTemplate = `function createQuizForm() {
  // è‡ªå‹•å–å¾—ç•¶å‰ç¶å®šçš„ Google è¡¨å–®
  const form = FormApp.getActiveForm();

  // è¨­å®šæ¯é¡Œçš„åˆ†æ•¸ï¼Œä½ å¯ä»¥ä¿®æ”¹é€™å€‹å€¼
  const pointsPerQuestion = 5;

  // è¨­å®šè¡¨å–®æ¨™é¡Œ
  form.setTitle("${formTitle.replace(/\\/g, '\\\\').replace(/"/g, '\\"')}");

  // è¨­å®šè¡¨å–®èªªæ˜
  form.setDescription("${formDescription}");

  // AI ç”Ÿæˆçš„é¡Œç›®
  const questions = ${JSON.stringify(questions.map(q => ({
    title: q.questionText,
    choices: q.options,
    answer: q.options[q.correctAnswerIndex]
  })), null, 2)};

  // è¨­å®šè¡¨å–®ç‚ºæ¸¬é©—æ¨¡å¼
  form.setIsQuiz(true);

  questions.forEach(q => {
    const item = form.addMultipleChoiceItem();
    item.setTitle(q.title);

    const choices = q.choices.map(choice =>
      item.createChoice(choice, choice === q.answer) // å¦‚æœæ˜¯æ­£ç¢ºç­”æ¡ˆï¼Œå‰‡è¨­å®šç‚ºæ­£ç¢º
    );
    item.setChoices(choices);
    item.setPoints(pointsPerQuestion); // è¨­å®šæ¯é¡Œçš„åˆ†æ•¸
    item.setRequired(true); // è¨­å®šç‚ºå¿…å¡«
  });

  Logger.log('æˆåŠŸæ–°å¢æ‰€æœ‰é¡Œç›®åˆ°è¡¨å–®ï¼');
}`;
            return gasTemplate;
        },

        // ç²å–ç•¶å‰æ¸¬é©—çš„åŸå§‹æ–‡æœ¬ï¼ˆå¦‚æœä¾†è‡ªé–±è®€ç†è§£é¡å‹ï¼‰
        getSourceTextForCurrentQuiz() {
            // æª¢æŸ¥é¸ä¸­çš„é¡Œåº«æ˜¯å¦åŒ…å«é–±è®€ç†è§£é¡å‹
            const selectedTypes = this.getSelectedBankTypes();
            if (!selectedTypes.has('comprehension')) {
                return null; // ä¸æ˜¯é–±è®€ç†è§£é¡å‹
            }

            // ç²å–é¸ä¸­çš„é–±è®€ç†è§£é¡Œåº«çš„åŸå§‹æ–‡æœ¬
            for (const bank of this.questionBanks) {
                if (this.selectedBankIds.has(bank.id)) {
                    const bankType = this.detectBankType(bank);
                    if (bankType === 'comprehension' && bank.sourceText) {
                        return bank.sourceText;
                    }
                }
            }

            return null;
        },

        copyGasCode() {
            const gasCode = document.getElementById('gas-code-content').textContent;
            const textarea = document.createElement('textarea');
            textarea.value = gasCode;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            // é¡¯ç¤ºè¤‡è£½æˆåŠŸè¨Šæ¯
            const copyBtn = document.getElementById('copy-gas-code-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'å·²è¤‡è£½ï¼';
            copyBtn.style.backgroundColor = '#10b981';
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.backgroundColor = '';
            }, 2000);
        },

        openGasInstructionsModal() {
            document.getElementById('gas-instructions-modal').classList.remove('hidden');
            document.getElementById('gas-instructions-modal').classList.add('flex');
        },

        closeGasInstructionsModal() {
            document.getElementById('gas-instructions-modal').classList.add('hidden');
            document.getElementById('gas-instructions-modal').classList.remove('flex');
        },

        closeGoogleFormsModal() {
            document.getElementById('google-forms-modal').classList.add('hidden');
            document.getElementById('google-forms-modal').classList.remove('flex');
        },
        async exportAllData() { if(this.questionBanks.length===0){alert("æ²’æœ‰ä»»ä½•è³‡æ–™å¯ä»¥åŒ¯å‡ºã€‚");return;}
const dataStr=JSON.stringify(this.questionBanks,null,2);this.downloadFile(dataStr,'ai_quiz_backup.json','application/json');},
        importAllData(event) { const file=event.target.files[0];if(!file)return;if(!confirm("åŒ¯å…¥é¡Œåº«è³‡æ–™ï¼Œå¦‚æœ‰ç›¸åŒå…§å®¹çš„é¡Œåº«å°‡åªä¿ç•™ä¸€å€‹ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")){event.target.value='';return;}
const reader=new FileReader();reader.onload=(e)=>{try{const importedBanks=JSON.parse(e.target.result);if(!Array.isArray(importedBanks))throw new Error("JSON æ ¼å¼ä¸æ­£ç¢ºã€‚");if(importedBanks.length>0){const first=importedBanks[0];if(!first.id||!first.name||!first.categories){throw new Error("JSON æª”æ¡ˆçµæ§‹ä¸ç¬¦ã€‚");}}
// å»ºç«‹å…§å®¹æ¯”å°ç”¨çš„å‡½æ•¸
const getBankContentSignature = (bank) => {
    const categories = (bank.categories || []).map(cat => ({
        name: cat.name,
        questions: (cat.questions || []).map(q => ({
            questionText: q.questionText?.trim(),
            options: q.options || [],
            correctAnswerIndex: q.correctAnswerIndex,
            difficulty: q.difficulty
        }))
    }));
    return JSON.stringify(categories);
};
// è¼‰å…¥ç¾æœ‰é¡Œåº«é€²è¡Œæ¯”å°
const transaction=this.db.transaction(["questionBanks"],"readwrite");const store=transaction.objectStore("questionBanks");const getAllRequest=store.getAll();
getAllRequest.onsuccess=()=>{
    const existingBanks=getAllRequest.result;
    const existingSignatures=new Set();
    const banksToKeep=[];
    // å»ºç«‹ç¾æœ‰é¡Œåº«çš„å…§å®¹ç°½å
    existingBanks.forEach(bank=>{
        const signature=getBankContentSignature(bank);
        if(!existingSignatures.has(signature)){
            existingSignatures.add(signature);
            banksToKeep.push(bank);
        }
    });
    // æª¢æŸ¥åŒ¯å…¥çš„é¡Œåº«ï¼Œåªæ·»åŠ å…§å®¹ä¸é‡è¤‡çš„
    let addedCount=0;
    importedBanks.forEach(importBank=>{
        const signature=getBankContentSignature(importBank);
        if(!existingSignatures.has(signature)){
            existingSignatures.add(signature);
            banksToKeep.push({...importBank,id:`bank-${Date.now()}-${Math.random().toString(36).substr(2,9)}`});
            addedCount++;
        }
    });
    // æ¸…ç©ºè³‡æ–™åº«ä¸¦é‡æ–°å¯«å…¥å»é‡å¾Œçš„é¡Œåº«
    store.clear();
    banksToKeep.forEach(bank=>{store.put(bank);});
    alert(`åŒ¯å…¥å®Œæˆï¼æ–°å¢äº† ${addedCount} å€‹é¡Œåº«ï¼Œå·²è‡ªå‹•å»é™¤é‡è¤‡å…§å®¹ã€‚`);
    this.loadBanksFromDB();
    this.closeDataModal();
};
getAllRequest.onerror=(event)=>{throw new Error("è®€å–ç¾æœ‰è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š"+event.target.errorCode);};}catch(error){alert(`åŒ¯å…¥å¤±æ•—ï¼š${error.message}`);}finally{event.target.value='';}};reader.readAsText(file);},

        openEditModal(bankId) {
            this.editingBankId = bankId;
            const bank = this.questionBanks.find(b => b.id === bankId);
            if (!bank) return;
            
            document.getElementById('edit-modal-title').textContent = `ç·¨è¼¯é¡Œåº«: ${bank.name}`;
            const contentEl = document.getElementById('edit-modal-content');
            contentEl.innerHTML = '';

            // æ·»åŠ é¡Œåº«æ¨™é¡Œç·¨è¼¯å€åŸŸ
            const titleSection = document.createElement('div');
            titleSection.className = 'mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg';
            titleSection.innerHTML = `
                <div class="mb-4">
                    <label class="font-bold block mb-2">é¡Œåº«æ¨™é¡Œ:</label>
                    <input type="text" id="edit-bank-title" class="pop-input w-full p-2" value="${bank.name.replace(/"/g, '&quot;')}">
                </div>
            `;
            contentEl.appendChild(titleSection);

            bank.categories.forEach((category, catIndex) => {
                const categoryEl = document.createElement('div');
                categoryEl.innerHTML = `<h3 class="text-xl font-bold mt-4 mb-2 p-2 bg-yellow-100 border-b-2 border-yellow-400">åˆ†é¡: ${category.name}</h3>`;
                
                category.questions.forEach((q, qIndex) => {
                    const questionCard = document.createElement('div');
                    questionCard.className = 'p-4 border border-gray-300 rounded-lg mb-4';
                    questionCard.dataset.catIndex = catIndex;
                    questionCard.dataset.qIndex = qIndex;

                    const optionsHtml = q.options.map((opt, optIndex) => `
                        <div class="flex items-center mb-1">
                            <input type="radio" name="correct-answer-${catIndex}-${qIndex}" value="${optIndex}" ${optIndex === q.correctAnswerIndex ? 'checked' : ''} class="mr-2">
                            <input type="text" value="${opt.replace(/"/g, '&quot;')}" class="pop-input w-full p-1 option-input">
                        </div>
                    `).join('');

                    questionCard.innerHTML = `
                        <label class="font-bold">é¡Œç›®:</label>
                        <textarea class="pop-textarea w-full h-24 p-1 question-text">${q.questionText}</textarea>
                        <label class="font-bold mt-2 block">é¸é … (è«‹å‹¾é¸æ­£ç¢ºç­”æ¡ˆ):</label>
                        ${optionsHtml}
                        <div class="mt-2 flex items-center justify-between">
                            <label class="font-bold">é¡å‹/é›£åº¦:</label>
                            <input type="text" class="pop-input p-1 difficulty-input" value="${q.difficulty}">
                        </div>
                    `;
                    categoryEl.appendChild(questionCard);
                });
                contentEl.appendChild(categoryEl);
            });

            document.getElementById('edit-bank-modal').classList.replace('hidden', 'flex');
        },

        closeEditModal() {
            document.getElementById('edit-bank-modal').classList.replace('flex', 'hidden');
            this.editingBankId = null;
        },

        saveBankEdits() {
            const bank = this.questionBanks.find(b => b.id === this.editingBankId);
            if (!bank) return;

            // æ›´æ–°é¡Œåº«æ¨™é¡Œ
            const titleInput = document.getElementById('edit-bank-title');
            if (titleInput) {
                bank.name = titleInput.value.trim() || bank.name;
            }

            const contentEl = document.getElementById('edit-modal-content');
            contentEl.querySelectorAll('[data-cat-index]').forEach(card => {
                const catIndex = parseInt(card.dataset.catIndex, 10);
                const qIndex = parseInt(card.dataset.qIndex, 10);
                
                const question = bank.categories[catIndex].questions[qIndex];
                
                question.questionText = card.querySelector('.question-text').value;
                question.difficulty = card.querySelector('.difficulty-input').value;
                question.correctAnswerIndex = parseInt(card.querySelector('input[type="radio"]:checked').value, 10);
                question.options = Array.from(card.querySelectorAll('.option-input')).map(input => input.value);
            });

            this.saveBankToDB(bank);
            this.closeEditModal();
            this.renderBankList();
            alert('è®Šæ›´å·²å„²å­˜ï¼');
        },

        loadMaterialLibrary() {
            const materialList = document.getElementById('material-list');
            const noMaterials = document.getElementById('no-materials');

            // æ¸…ç©ºç¾æœ‰åˆ—è¡¨
            materialList.innerHTML = '';

            // ç²å–æ‰€æœ‰æœ‰ sourceText çš„é¡Œåº«
            const materialsWithSource = this.questionBanks.filter(bank => bank.sourceText && bank.sourceText.trim());

            // å»é‡ï¼šå°æ–¼ç›¸åŒçš„ sourceTextï¼Œåªä¿ç•™æœ€æ—©å‰µå»ºçš„é¡Œåº«ï¼ˆID ä¸­æ™‚é–“æˆ³æœ€å°çš„ï¼‰
            const uniqueMaterials = [];
            const sourceTextMap = new Map();

            materialsWithSource.forEach(bank => {
                const sourceText = bank.sourceText.trim();

                if (!sourceTextMap.has(sourceText)) {
                    // ç¬¬ä¸€æ¬¡é‡åˆ°é€™å€‹ sourceText
                    sourceTextMap.set(sourceText, bank);
                    uniqueMaterials.push(bank);
                } else {
                    // å·²ç¶“å­˜åœ¨ç›¸åŒçš„ sourceTextï¼Œæ¯”è¼ƒå‰µå»ºæ™‚é–“
                    const existingBank = sourceTextMap.get(sourceText);

                    // å¾ ID ä¸­æå–æ™‚é–“æˆ³é€²è¡Œæ¯”è¼ƒ (æ ¼å¼: bank-{timestamp})
                    const existingTimestamp = parseInt(existingBank.id.split('-')[1]);
                    const currentTimestamp = parseInt(bank.id.split('-')[1]);

                    if (currentTimestamp < existingTimestamp) {
                        // ç•¶å‰é¡Œåº«æ›´æ—©ï¼Œæ›¿æ›åŸæœ‰çš„
                        const index = uniqueMaterials.indexOf(existingBank);
                        uniqueMaterials[index] = bank;
                        sourceTextMap.set(sourceText, bank);
                    }
                    // å¦‚æœç•¶å‰é¡Œåº«è¼ƒæ™šï¼Œå‰‡å¿½ç•¥å®ƒ
                }
            });

            if (uniqueMaterials.length === 0) {
                noMaterials.classList.remove('hidden');
                return;
            }

            noMaterials.classList.add('hidden');

            uniqueMaterials.forEach(bank => {
                const materialItem = document.createElement('div');
                materialItem.className = 'p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors';
                materialItem.dataset.bankId = bank.id;

                // æˆªå–æ–‡æœ¬é è¦½ï¼ˆå‰100å­—ï¼‰
                const preview = bank.sourceText.length > 100
                    ? bank.sourceText.substring(0, 100) + '...'
                    : bank.sourceText;

                materialItem.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-blue-600">${bank.name}</h4>
                            <p class="text-sm text-gray-600 mt-1 line-clamp-3">${preview}</p>
                            <div class="flex items-center gap-4 mt-2 text-xs text-gray-500">
                                <span>${bank.categories?.length || 0} å€‹åˆ†é¡</span>
                                <span>${bank.categories?.reduce((sum, cat) => sum + (cat.questions?.length || 0), 0) || 0} é¡Œ</span>
                            </div>
                        </div>
                        <div class="ml-4 flex gap-2">
                            <button class="select-material-btn pop-button bg-blue-400 hover:bg-blue-500 px-3 py-1 rounded text-sm whitespace-nowrap" data-bank-id="${bank.id}">
                                é¸ç”¨æ­¤æ•™æ
                            </button>
                            <button class="delete-material-btn pop-button bg-red-400 hover:bg-red-500 px-3 py-1 rounded text-sm whitespace-nowrap" data-bank-id="${bank.id}" title="åˆªé™¤æ•™æ">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;

                materialList.appendChild(materialItem);
            });

            // ç‚ºæŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
            materialList.querySelectorAll('.select-material-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectMaterial(e.target.dataset.bankId);
                });
            });

            materialList.querySelectorAll('.delete-material-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteMaterial(e.target.dataset.bankId);
                });
            });
        },

        selectMaterial(bankId) {
            const bank = this.questionBanks.find(b => b.id === bankId);
            if (!bank || !bank.sourceText) {
                alert('ç„¡æ³•æ‰¾åˆ°è©²æ•™æçš„å…§å®¹ã€‚');
                return;
            }

            // å°‡æ•™æå…§å®¹å¡«å…¥æ–‡å­—è¼¸å…¥å€åŸŸ
            document.getElementById('text-input').value = bank.sourceText;

            // åˆ‡æ›åˆ°è²¼ä¸Šæ–‡å­—é¸é …å¡
            this.switchTab('paste');

            // é å¡«å»ºè­°çš„é¡Œåº«åç¨±
            document.getElementById('bank-name').value = `${bank.name}_æ–°ç‰ˆæœ¬`;
            document.getElementById('bank-name').placeholder = `ä¾‹å¦‚ï¼š${bank.name}_æ–°ç‰ˆæœ¬`;

            alert(`å·²è¼‰å…¥ã€Œ${bank.name}ã€çš„æ•™æå…§å®¹ï¼Œè«‹é‡æ–°è¨­å®šé¡Œåº«åç¨±å’ŒAIç”Ÿæˆåƒæ•¸ã€‚`);
        },

        deleteMaterial(bankId) {
            const bank = this.questionBanks.find(b => b.id === bankId);
            if (!bank) {
                alert('æ‰¾ä¸åˆ°è©²æ•™æã€‚');
                return;
            }

            // æ‰¾åˆ°æ‰€æœ‰ä½¿ç”¨ç›¸åŒæ•™æå…§å®¹çš„é¡Œåº«
            const sourceText = bank.sourceText.trim();
            const relatedBanks = this.questionBanks.filter(b =>
                b.sourceText && b.sourceText.trim() === sourceText
            );

            const confirmMessage = `ç¢ºå®šè¦å¾æ•™æåº«ä¸­ç§»é™¤ã€Œ${bank.name}ã€å—ï¼Ÿ\n\nğŸ“ æ³¨æ„ï¼š\nâ€¢ é€™åªæœƒå¾æ•™æåº«åˆ—è¡¨ä¸­ç§»é™¤æ­¤æ•™æ\nâ€¢ å·²å»ºç«‹çš„ ${relatedBanks.length} å€‹ç›¸é—œé¡Œåº«å°‡æœƒä¿ç•™\nâ€¢ æ‚¨ä»å¯åœ¨é¡Œåº«åˆ—è¡¨ä¸­ä½¿ç”¨é€™äº›é¡Œåº«\nâ€¢ æ­¤æ“ä½œåƒ…æ¸…é™¤æ•™æçš„ sourceTextï¼Œç„¡æ³•å¾©åŸ`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // æ¸…é™¤æ‰€æœ‰ç›¸é—œé¡Œåº«çš„ sourceTextï¼Œä½†ä¿ç•™é¡Œåº«æœ¬èº«
                const transaction = this.db.transaction(["questionBanks"], "readwrite");
                const store = transaction.objectStore("questionBanks");
                let completedCount = 0;

                relatedBanks.forEach(relatedBank => {
                    // å‰µå»ºæ–°çš„é¡Œåº«å°è±¡ï¼Œæ¸…é™¤ sourceText
                    const updatedBank = { ...relatedBank };
                    delete updatedBank.sourceText;

                    // æ›´æ–°è¨˜æ†¶é«”ä¸­çš„é¡Œåº«
                    const memoryIndex = this.questionBanks.findIndex(b => b.id === relatedBank.id);
                    if (memoryIndex !== -1) {
                        this.questionBanks[memoryIndex] = updatedBank;
                    }

                    // æ›´æ–°è³‡æ–™åº«
                    const updateRequest = store.put(updatedBank);

                    updateRequest.onsuccess = () => {
                        completedCount++;
                        if (completedCount === relatedBanks.length) {
                            // æ‰€æœ‰æ›´æ–°å®Œæˆ
                            this.loadMaterialLibrary();
                            this.renderBankList();
                            alert(`æ•™æã€Œ${bank.name}ã€å·²å¾æ•™æåº«ä¸­ç§»é™¤ã€‚\nç›¸é—œçš„ ${relatedBanks.length} å€‹é¡Œåº«å·²ä¿ç•™ã€‚`);
                        }
                    };

                    updateRequest.onerror = (event) => {
                        console.error('æ›´æ–°å¤±æ•—:', event);
                        alert('ç§»é™¤æ•™ææ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    };
                });

            } catch (error) {
                console.error('ç§»é™¤æ•™ææ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('ç§»é™¤æ•™æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        },

        // æ–°å¢æ•™ææ¨¡æ…‹æ¡†
        openMaterialModal() {
            document.getElementById('material-modal').classList.replace('hidden', 'flex');
        },

        closeMaterialModal() {
            document.getElementById('material-modal').classList.replace('flex', 'hidden');
        },

        // è³‡æ–™ç®¡ç†æ¨¡æ…‹æ¡†
        openDataModal() {
            document.getElementById('data-modal').classList.replace('hidden', 'flex');
        },

        closeDataModal() {
            document.getElementById('data-modal').classList.replace('flex', 'hidden');
        },

        openGameSelectModal() {
            if (this.currentQuiz.length === 0) {
                alert('è«‹å…ˆç”Ÿæˆç·´ç¿’é¡Œï¼');
                return;
            }

            // æ·»åŠ éŠæˆ²é¸é …æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            document.querySelectorAll('.game-option-btn').forEach(btn => {
                btn.addEventListener('click', (e) => this.downloadGameWithQuiz(e.target.closest('.game-option-btn').dataset.url, e.target.closest('.game-option-btn').dataset.game));
            });

            document.getElementById('game-select-modal').classList.replace('hidden', 'flex');
        },

        closeGameSelectModal() {
            document.getElementById('game-select-modal').classList.replace('flex', 'hidden');
        },

        async downloadGameWithQuiz(gameUrl, gameName) {
            try {
                this.showLoading('æ­£åœ¨è¼‰å…¥éŠæˆ²ä¸¦å¡«å…¥é¡Œåº«...');
                this.closeGameSelectModal();

                // è¼‰å…¥éŠæˆ²HTML
                const response = await fetch(gameUrl);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥éŠæˆ²ï¼š${response.status}`);
                }

                let gameHTML = await response.text();

                // è½‰æ›é¡Œåº«æ ¼å¼ä¸¦å¡«å…¥HTML
                const quizData = this.convertQuizForGame();
                gameHTML = this.injectQuizIntoGame(gameHTML, quizData);

                // ç›´æ¥ä¸‹è¼‰ä¿®æ”¹å¾Œçš„HTML
                const fileName = `${gameName}_éŠæˆ²_${Date.now()}.html`;
                this.downloadFile(gameHTML, fileName, 'text/html;charset=utf-8;');

            } catch (error) {
                console.error('ä¸‹è¼‰éŠæˆ²å¤±æ•—:', error);
                alert(`ä¸‹è¼‰éŠæˆ²å¤±æ•—ï¼š${error.message}`);
            } finally {
                this.hideLoading();
            }
        },

        convertQuizForGame() {
            // å°‡é¡Œåº«è½‰æ›ç‚ºé©åˆtextareaæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä½¿ç”¨èˆ‡æ›¸å•†æ ¼å¼ç›¸åŒçš„é †åº
            let gameContent = '';

            this.currentQuiz.forEach((q, index) => {
                const question = q.questionText;
                const options = q.options.map(opt => opt);
                const answer = q.correctAnswerIndex + 1; // ç­”æ¡ˆå¾1é–‹å§‹è¨ˆç®—

                // ç¢ºä¿æœ‰4å€‹é¸é …
                while (options.length < 4) {
                    options.push('');
                }

                // ä½¿ç”¨èˆ‡æ›¸å•†æ ¼å¼ç›¸åŒçš„é †åºï¼šé¡Œç›®\tç­”æ¡ˆ\té¸é …A\té¸é …B\té¸é …C\té¸é …D
                const line = [question, answer, ...options.slice(0, 4)].join('\t');
                gameContent += line + '\r\n';
            });

            return gameContent.trim();
        },

        injectQuizIntoGame(gameHTML, quizData) {
            // ä½¿ç”¨DOMParserè§£æHTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(gameHTML, 'text/html');

            // å°‹æ‰¾æ‰€æœ‰textareaå…ƒç´ 
            const textareas = doc.querySelectorAll('textarea');

            if (textareas.length > 0) {
                // å°‡é¡Œåº«è³‡æ–™å¡«å…¥ç¬¬ä¸€å€‹textarea
                textareas[0].textContent = quizData;
            } else {
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°textareaï¼Œå˜—è©¦å°‹æ‰¾å…¶ä»–å¯èƒ½çš„å®¹å™¨
                console.warn('æœªæ‰¾åˆ°textareaå…ƒç´ ï¼Œé¡Œåº«å¯èƒ½ç„¡æ³•æ­£ç¢ºå¡«å…¥');
            }

            // å°‡ä¿®æ”¹å¾Œçš„æ–‡æª”è½‰å›HTMLå­—ç¬¦ä¸²
            return `<!DOCTYPE html>\n${doc.documentElement.outerHTML}`;
        },

        openManualSelectModal() {
            const contentEl = document.getElementById('manual-select-content');
            contentEl.innerHTML = '';
            let questionCounter = 0;

            this.questionBanks.forEach(bank => {
                if (this.selectedBankIds.has(bank.id)) {
                    bank.categories.forEach(cat => {
                        (cat.questions || []).forEach(q => {
                            questionCounter++;
                            const itemEl = document.createElement('div');
                            itemEl.className = 'p-3 mb-2 border rounded-md hover:bg-gray-100';
                            itemEl.innerHTML = `
                                <label class="flex items-start">
                                    <input type="checkbox" class="manual-q-checkbox h-5 w-5 mt-1 mr-3" data-question='${JSON.stringify(q)}'>
                                    <div>
                                        <p>${questionCounter}. ${q.questionText}</p>
                                        <p class="text-sm text-gray-500">(${bank.name} - ${cat.name} - ${q.difficulty})</p>
                                    </div>
                                </label>
                            `;
                            contentEl.appendChild(itemEl);
                        });
                    });
                }
            });

            if (questionCounter === 0) return alert('é¸ä¸­çš„é¡Œåº«ä¸­æ²’æœ‰é¡Œç›®å¯ä¾›é¸æ“‡ã€‚');
            document.getElementById('manual-select-modal').classList.replace('hidden', 'flex');
        },
        
        closeManualSelectModal() {
            document.getElementById('manual-select-modal').classList.replace('flex', 'hidden');
        },
        
        generateManualQuiz() {
            const selectedQuestions = [];
            document.querySelectorAll('.manual-q-checkbox:checked').forEach(checkbox => {
                selectedQuestions.push(JSON.parse(checkbox.dataset.question));
            });
            
            if (selectedQuestions.length === 0) {
                return alert('æ‚¨æ²’æœ‰é¸æ“‡ä»»ä½•é¡Œç›®ï¼');
            }

            this.currentQuiz = selectedQuestions;
            this.renderQuizPreview();
            this.closeManualSelectModal();
        },

        // --------- NEW FUNCTIONS FOR BATCH ADD ---------
        openAddQuestionsModal() {
            // This function is for creating a NEW bank from pasted content
            document.getElementById('new-bank-name').value = '';
            document.getElementById('new-question-category').value = '';
            document.getElementById('batch-input-text').value = '';
            document.getElementById('new-question-type').value = 'knowledge';
            this.updateDifficultyOptions(); 
            document.getElementById('add-questions-modal').classList.replace('hidden', 'flex');
        },

        closeAddQuestionsModal() {
            document.getElementById('add-questions-modal').classList.replace('flex', 'hidden');
        },

        updateDifficultyOptions() {
            const type = document.getElementById('new-question-type').value;
            const difficultySelect = document.getElementById('new-question-difficulty');
            difficultySelect.innerHTML = '';
            let options = [];
            if (type === 'knowledge') {
                options = ['Easy', 'Medium', 'Hard'];
            } else {
                options = ['æå–è¨Šæ¯', 'æ–‡æ„æ¨è«–', 'è©®é‡‹æ•´åˆ', 'åæ€è©•åƒ¹'];
            }
            options.forEach(opt => {
                const optionEl = document.createElement('option');
                optionEl.value = opt;
                optionEl.textContent = opt;
                difficultySelect.appendChild(optionEl);
            });
            if (type === 'knowledge') {
                difficultySelect.value = 'Medium'; // Default to medium
            }
        },

        saveNewQuestions() {
            const bankName = document.getElementById('new-bank-name').value.trim();
            const categoryName = document.getElementById('new-question-category').value.trim();
            const difficulty = document.getElementById('new-question-difficulty').value;
            const text = document.getElementById('batch-input-text').value.trim();

            if (!bankName) {
                alert('è«‹è¼¸å…¥æ–°é¡Œåº«çš„åç¨±ï¼');
                return;
            }
            if (!categoryName) {
                alert('è«‹è¼¸å…¥é¡Œç›®åˆ†é¡åç¨±ï¼');
                return;
            }
            if (!text) {
                alert('è«‹è²¼ä¸Šé¡Œç›®å…§å®¹ï¼');
                return;
            }

            try {
                const newQuestions = this.parsePublisherFormat(text, difficulty);
                if (newQuestions.length === 0) {
                    alert('æ²’æœ‰æˆåŠŸè§£æä»»ä½•é¡Œç›®ï¼Œè«‹æª¢æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚\næ ¼å¼æ‡‰ç‚ºï¼šé¡Œç›®(Tab)ç­”æ¡ˆæ•¸å­—(Tab)é¸é …A(Tab)é¸é …B(Tab)é¸é …C(Tab)é¸é …D');
                    return;
                }
                
                // Create a new bank object
                const newBank = {
                    id: `bank-${Date.now()}`,
                    name: bankName,
                    sourceText: null, // No source text for manually created banks
                    categories: [{
                        name: categoryName,
                        questions: newQuestions
                    }]
                };

                this.saveBankToDB(newBank, true); // The 'true' flag will trigger a list refresh
                this.closeAddQuestionsModal();
                
                alert(`æˆåŠŸå»ºç«‹é¡Œåº«ã€Œ${bankName}ã€ä¸¦æ–°å¢ ${newQuestions.length} é¡Œï¼`);

            } catch (error) {
                alert(`å»ºç«‹é¡Œåº«å¤±æ•—ï¼š${error.message}`);
            }
        },

        parsePublisherFormat(text, difficulty) {
            const questions = [];
            const lines = text.split('\n').filter(line => line.trim() !== '');

            for (const line of lines) {
                const parts = line.split('\t');
                if (parts.length < 6) {
                    console.warn('Skipping malformed line (not enough parts):', line);
                    continue;
                }

                const questionText = parts[0].trim();
                const correctAnswerIndex = parseInt(parts[1], 10) - 1; // Publisher format is 1-based, our app is 0-based
                const options = parts.slice(2, 6).map(opt => opt.trim());

                if (questionText && !isNaN(correctAnswerIndex) && correctAnswerIndex >= 0 && correctAnswerIndex < 4 && options.length === 4) {
                     questions.push({
                        questionText,
                        options,
                        correctAnswerIndex,
                        difficulty
                    });
                } else {
                     console.warn('Skipping invalid data line:', line);
                }
            }
            return questions;
        }

    };

    window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>

